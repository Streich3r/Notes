<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Handle D&D Test (Opera Fix)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* ************************************** */
        /* CSS STYLES */
        /* ************************************** */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1f2937; /* Dunkler Hintergrund */
            color: #f3f4f6;
        }

        #notes-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            border: 2px solid #374151;
            border-radius: 8px;
        }

        .note-card {
            display: flex; /* Flexbox für Handle links, Inhalt rechts */
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            background-color: #4b5563; /* Mittelgraue Karte */
            transition: transform 0.2s, opacity 0.2s;
            
            /* WICHTIG: Das ganze Element muss keine touch-action: none haben, nur das Handle */
        }
        
        .drag-handle {
            padding: 8px 15px 8px 5px; /* Größerer Touch-Bereich */
            margin-right: 10px;
            cursor: grab;
            color: #9ca3af; 
            font-size: 1.2em;
            
            /* WICHTIG: Hier blockieren wir die nativen Gesten (Markieren/Scrollen) */
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }
        
        .note-body {
            flex-grow: 1;
        }

        .note-body .note-content {
            font-size: 0.9em;
            color: #d1d5db;
            /* Wichtig: Markieren im Text ist erlaubt */
            user-select: text; 
            -webkit-user-select: text;
        }

        .note-card.dragging {
            opacity: 0.4;
            transform: scale(0.98);
        }
    </style>
</head>
<body>

    <h1>Handle Drag & Drop Test</h1>
    <p>Bitte verwenden Sie das **Griff-Icon** (<i class="fas fa-grip-vertical"></i>) zum Ziehen auf Mobilgeräten.</p>
    <p>Text im Body kann weiterhin markiert werden.</p>

    <div id="notes-container">
        </div>

    <script>
        // **************************************
        // ** JAVASCRIPT LOGIC **
        // **************************************

        // Globale Variablen
        const notesList = document.getElementById('notes-container');
        let draggedItem = null;
        let isDragging = false;
        const DRAG_THRESHOLD = 5; // Pixel-Toleranz für Bewegung
        
        // Gerätekennung
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        // Simuliere notesData für das Speichern
        let notesData = [
            { id: '1', title: 'Erste Notiz', content: 'Dies ist Notiz 1. Versuch, diesen Text zu markieren.' },
            { id: '2', title: 'Zweite Notiz', content: 'Dies ist Notiz 2. Drücken Sie das Handle-Icon (<i class="fas fa-grip-vertical"></i>) zum Ziehen.' },
            { id: '3', title: 'Dritte Notiz', content: 'Dies ist Notiz 3. Eine lange Notiz zum Testen.' }
        ];

        // *** HILFSFUNKTIONEN ***
        const saveNotesToLocal = () => {
             console.log("Daten gespeichert. Neue Reihenfolge:", notesData.map(n => n.id));
             // Hier würde die eigentliche localStorage-Speicherung erfolgen.
        };

        const createNoteCard = (note) => {
            const card = document.createElement('div');
            card.className = 'note-card';
            card.dataset.id = note.id;
            card.innerHTML = `
                <div class="drag-handle"><i class="fas fa-grip-vertical"></i></div>
                <div class="note-body">
                    <b>${note.title}</b>
                    <div class="note-content">${note.content}</div>
                </div>
            `;
            return card;
        };

        const renderNotes = () => {
            notesList.innerHTML = '';
            notesData.forEach(note => {
                notesList.appendChild(createNoteCard(note));
            });
            setupDragAndDrop();
        };


        // ******************************************************
        // ** TOUCH-HANDLER FUNKTIONEN (Handle-Basiert) **
        // ******************************************************

        function handleTouchStart(e) {
            // Nur starten, wenn das Handle berührt wurde
            if (!e.target.closest('.drag-handle')) return; 
            if (e.touches.length !== 1) return;
            
            // Verhindert Scrollen oder Zoomen, solange der Finger auf dem Handle ist
            e.preventDefault(); 
            
            // Die noteCard ist das Elternelement des Handles
            const noteCard = e.target.closest('.note-card');
            draggedItem = noteCard;
            
            // Speichern der Startposition für die Schwellwertprüfung
            noteCard.initialX = e.touches[0].clientX;
            noteCard.initialY = e.touches[0].clientY;
            
            // Listener hinzufügen
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
        }

        function handleTouchMove(e) {
            if (!draggedItem) return;
            
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const dx = Math.abs(currentX - draggedItem.initialX);
            const dy = Math.abs(currentY - draggedItem.initialY);

            // Bedingung 1: Drag-Modus starten, sobald die Schwelle überschritten ist
            if (!isDragging && (dx > DRAG_THRESHOLD || dy > DRAG_THRESHOLD)) {
                isDragging = true;
                // CSS Klasse hinzufügen
                draggedItem.classList.add('dragging');
            }
            
            // Bedingung 2: Nur wenn der Drag-Modus aktiv ist, verschieben wir das Element
            if (isDragging) {
                e.preventDefault(); 
                
                // RE-ORDERING LOGIK (Emulation von dragover)
                const targetElement = document.elementFromPoint(currentX, currentY);
                const targetCard = targetElement ? targetElement.closest('.note-card') : null;

                if (targetCard && targetCard !== draggedItem) {
                    const bounding = targetCard.getBoundingClientRect();
                    const offset = bounding.y + (bounding.height / 2);
                    
                    if (currentY < offset) {
                        notesList.insertBefore(draggedItem, targetCard);
                    } else {
                        notesList.insertBefore(draggedItem, targetCard.nextElementSibling);
                    }
                }
            }
        }

        function handleTouchEnd(e) {
            if (!draggedItem) return;

            // Speichere nur, wenn ein tatsächlicher Drag stattfand
            if (isDragging) {
                // Speicherlogik (Reihenfolge aktualisieren)
                const newOrder = Array.from(notesList.children).map(child => String(child.dataset.id));
                notesData.sort((a, b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
                saveNotesToLocal();
            }
            
            // Aufräumen
            draggedItem.classList.remove('dragging');
            draggedItem = null;
            isDragging = false; 

            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', handleTouchEnd);
        }
        
        // ******************************************************
        // ** DRAG-AND-DROP SETUP FUNKTION (HYBRID) **
        // ******************************************************

        const setupDragAndDrop = () => {
            const noteCards = notesList.querySelectorAll('.note-card');

            noteCards.forEach(card => {
                
                // Setze das "draggable"-Attribut nur für Maus-Geräte
                card.setAttribute('draggable', isTouchDevice ? 'false' : 'true');

                if (isTouchDevice) {
                    // *** TOUCH-LOGIK: Handle-basiertes Dragging ***
                    // Wir hören auf das Handle, nicht auf die Karte selbst
                    const handle = card.querySelector('.drag-handle');
                    if (handle) {
                        handle.addEventListener('touchstart', handleTouchStart, { passive: false });
                    }
                    
                } else {
                    // *** MAUS-LOGIK: Native HTML5 D&D (startet nur auf dem Handle) ***
                    card.addEventListener('dragstart', (e) => {
                        // Dragging startet nur, wenn der Benutzer auf das Handle klickt
                        if (!e.target.closest('.drag-handle')) {
                            e.preventDefault();
                            return;
                        }
                        
                        draggedItem = card;
                        e.dataTransfer.setData('text/plain', '');
                        setTimeout(() => card.classList.add('dragging'), 0);
                    });

                    card.addEventListener('dragend', () => {
                        setTimeout(() => {
                            draggedItem.classList.remove('dragging');
                            draggedItem = null;
                            
                            // Speicherlogik
                            const newOrder = Array.from(notesList.children).map(child => String(child.dataset.id));
                            notesData.sort((a, b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
                            saveNotesToLocal();
                        }, 0);
                    });

                    card.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        if (draggedItem && draggedItem !== card) {
                            const bounding = card.getBoundingClientRect();
                            const offset = bounding.y + (bounding.height / 2);

                            if (e.clientY < offset) {
                                notesList.insertBefore(draggedItem, card);
                            } else {
                                notesList.insertBefore(draggedItem, card.nextElementSibling);
                            }
                        }
                    });
                }
            });
        };

        // Starte die Anwendung
        document.addEventListener('DOMContentLoaded', renderNotes);
    </script>
</body>
</html>
