<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Meine Offline-Notizen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        :root{
            /* BASICS */
            --btn-gray: #4b5563; /* bg-gray-600 */
            --btn-blue: #2563eb; /* bg-blue-600 */
            --btn-green: #10b981; /* bg-green-600 */
            --btn-yellow: #fbbf24; /* bg-yellow-600 */
            --accent: #6aa1ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
        }

        .note-card {
            background-color: #1a202c;
            border-color: #2d3748;
            cursor: grab;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .note-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        #note-editor {
            min-height: 100px;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #4a5568; 
            background-color: #1a202c;
            color: #ffffff;
            outline: none; 
            transition: all 0.3s;
        }
        
        #note-editor:focus {
            outline: none !important;
        }

        /* ----------------------------------------------------- */
        /* --- RECHNER-PRINZIP CSS-REGELN F√úR ALLE BUTTONS --- */
        /* ----------------------------------------------------- */
        .calculator-btn, label[for="import-file-input"] {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            transition: transform .06s ease, background-color 0.2s ease;
            border: none;
        }

        .calculator-btn:active, label[for="import-file-input"]:active {
            transform: scale(0.96);
        }

        .calculator-btn:focus, label[for="import-file-input"]:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        .calculator-btn:focus-visible, label[for="import-file-input"]:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        /* Graue Buttons (Toolbar, Sort, Modal-Cancel) */
        .toolbar-btn, .dropdown-item, #sort-dropdown-btn, #modal-cancel-btn, #link-cancel-btn {
            background-color: var(--btn-gray) !important;
        }
        
        .toolbar-btn:hover:not(.active), .dropdown-item:hover:not(.active), #sort-dropdown-btn:hover, #modal-cancel-btn:hover, #link-cancel-btn:hover {
            background-color: var(--btn-gray) !important;
        }
        
        .toolbar-btn:active, .dropdown-item:active, #sort-dropdown-btn:active, #modal-cancel-btn:active, #link-cancel-btn:active {
             background-color: #374151 !important; /* bg-gray-700 */
        }

        /* WICHTIG: Blauer Hintergrund f√ºr aktive Toolbar-Buttons und Dropdown-Elemente */
        .toolbar-btn.active, .dropdown-item.active {
            background-color: var(--btn-blue) !important;
            color: #ffffff !important;
        }

        /* Blaue Buttons (Save, Modal-Confirm, Link-Insert) */
        #save-note-btn, #modal-confirm-btn, #link-insert-btn {
            background-color: var(--btn-blue) !important;
        }
        #save-note-btn:hover, #modal-confirm-btn:hover, #link-insert-btn:hover {
            background-color: #1d4ed8 !important; /* bg-blue-700 */
        }
        #save-note-btn:active, #modal-confirm-btn:active, #link-insert-btn:active {
            background-color: #1e40af !important; /* bg-blue-800 */
        }

        /* Gr√ºne Buttons (Export) */
        #export-btn {
            background-color: var(--btn-green) !important;
        }
        #export-btn:hover {
            background-color: #059669 !important; /* bg-green-700 */
        }
        #export-btn:active {
            background-color: #047857 !important; /* bg-green-800 */
        }
        
        /* Gelbe Buttons (Import) */
        label[for="import-file-input"] {
            background-color: var(--btn-yellow) !important;
        }
        label[for="import-file-input"]:hover {
             background-color: #f59e0b !important; /* bg-yellow-600/700 */
        }
        label[for="import-file-input"]:active {
            background-color: #a16207 !important; /* bg-yellow-800 */
        }
        
        /* Dropdown Men√º Styling */
        .dropdown-menu {
            position: absolute;
            z-index: 10;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            background-color: #374151; /* bg-gray-700 */
            border-radius: 0.5rem;
            padding: 0.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            width: max-content;
            min-width: 100%;
        }

        .dropdown-menu.active {
            display: flex;
        }

        #note-editor:empty:before {
            content: attr(placeholder);
            color: #718096;
            pointer-events: none;
            display: block;
        }
        
        /* Spezielle Regel f√ºr Link-F√§rbung im Editor */
        #note-editor a {
            color: #3b82f6; /* Tailwind blue-500 */
            text-decoration: underline;
        }
        
        /* --- STABILISIERTE LISTE-STYLES --- */
        #note-editor ul, #note-editor ol, .note-card ul, .note-card ol {
            margin: 0;
            padding-left: 1.5rem; 
        }
        
        #note-editor li, .note-card li {
            color: #ffffff !important;
        }

        #note-editor li::marker, .note-card li::marker {
            color: #ffffff !important;
        }
    </style>
</head>
<body class="bg-black min-h-screen p-4 flex items-center justify-center">

    <div class="bg-gray-900 p-6 rounded-3xl shadow-2xl w-full max-w-4xl transition-all duration-300 transform scale-100">
        <header class="mb-6 border-b pb-4 border-gray-700">
            <h1 class="text-4xl font-extrabold text-gray-100 text-center">
                Meine Offline-Notizen
            </h1>
        </header>

        <div class="mb-6 flex flex-col md:flex-row gap-4">
            <input type="text" id="search-input" placeholder="Notizen durchsuchen..." class="w-full md:w-1/3 p-3 rounded-xl border border-gray-600 bg-gray-800 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 focus:outline-none">
            
            <div class="flex flex-col sm:flex-row gap-4 w-full md:w-2/3">
                
                <div class="relative w-full sm:w-1/2">
                    <button 
                        id="sort-dropdown-btn" 
                        class="calculator-btn w-full p-3 rounded-xl border border-gray-600 bg-gray-800 text-gray-100 text-left">
                        Sortieren nach: Unsortiert
                    </button>
                    <div id="sort-dropdown-menu" class="dropdown-menu">
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg active" data-value="unsorted">Unsortiert</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="newest">Datum (neueste zuerst)</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="oldest">Datum (√§lteste zuerst)</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="title-asc">Titel (A-Z)</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="title-desc">Titel (Z-A)</button>
                    </div>
                </div>

                <div class="flex gap-2 w-full sm:w-1/2">
                    <button id="export-btn" class="calculator-btn w-1/2 p-3 rounded-xl border border-gray-600 text-white font-medium">
                        Export üíæ
                    </button>
                    <label for="import-file-input" 
                        class="w-1/2 p-3 rounded-xl border border-gray-600 text-white font-medium cursor-pointer text-center flex items-center justify-center">
                        Import üì•
                    </label>
                    <input type="file" id="import-file-input" accept="application/json" style="display: none;">
                </div>
            </div>
        </div>

    
        <div class="mb-6 p-4 bg-gray-800 rounded-2xl shadow-inner">
            <h2 class="text-2xl font-bold text-gray-200 mb-4">Neue Notiz erstellen</h2>
            
            <input type="text" id="note-title-input" placeholder="Titel der Notiz (optional)" class="w-full p-3 mb-4 rounded-xl border border-gray-600 bg-gray-800 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 focus:outline-none">
  
          
            <div class="flex flex-wrap gap-2 mb-4 p-2 bg-gray-700 rounded-xl">
                <button id="bold-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200 font-bold">B</button>
                <button id="italic-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200 italic">I</button>
                <button id="underline-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200 underline">U</button>
                
  
                <div class="relative inline-block">
                    <button id="list-dropdown-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
                        Aufz√§hlung
                    </button>
          
                    <div id="list-dropdown-menu" class="dropdown-menu">
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="decimal">Nummerierung</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="disc">Punkte</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="circle">Kreise</button>
                    </div>
                </div>

                <div class="relative inline-block">
                    <button id="size-dropdown-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
                        Schriftgr√∂√üe
                    </button>
                    <div id="size-dropdown-menu" class="dropdown-menu">
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="1">Klein</button>
 
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="3">Mittel</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="5">Gro√ü</button>
                    </div>
   
                </div>

              
                <div class="relative inline-block">
                    <button id="color-dropdown-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
                        Schriftfarbe
                    </button>
                    <div id="color-dropdown-menu" class="dropdown-menu">
 
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg text-white" data-value="white">Wei√ü</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg text-red-500" data-value="red">Rot</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg text-green-500" data-value="green">Gr√ºn</button>
  
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg text-blue-500" data-value="blue">Blau</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg text-yellow-500" data-value="yellow">Gelb</button>
                    </div>
                
                </div>

                <button id="link-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
                    Link
                </button>

                <button id="indent-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
                    Einr√ºcken
                </button>
                <button id="outdent-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
                    Ausr√ºcken
                </button>
            </div>
     
        
          
            <div id="note-editor" class="w-full rounded-xl border border-gray-600 bg-gray-800 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none transition-all duration-300" contenteditable="true" placeholder="Schreiben Sie hier Ihre neue Notiz..."></div>
  
            <div class="mt-4 flex justify-end space-x-2">
                <button id="save-note-btn" class="calculator-btn text-white font-medium py-2 px-5 rounded-full shadow-lg transform">
                    Notiz speichern
                </button>
            </div>
    
        </div>

        <div id="notes-list" class="space-y-4">
        </div>

        <div id="loading-indicator" class="text-center text-gray-400 mt-8 hidden">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
            <p class="mt-2">Notizen werden geladen...</p>
        </div>

        <div id="no-notes-message" class="text-center text-gray-400 mt-8 hidden">
            <p>Sie haben noch keine Notizen. F√ºgen Sie eine neue hinzu, um zu beginnen!</p>
        </div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-gray-950 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full">
            <p id="modal-text" class="text-lg font-semibold text-gray-200 text-center mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="modal-confirm-btn" class="calculator-btn text-white font-medium py-2 px-5 rounded-full">
                    OK
                </button>
                <button id="modal-cancel-btn" class="calculator-btn text-gray-200 font-medium py-2 px-5 rounded-full hidden">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>

    <div id="link-modal-backdrop" class="fixed inset-0 bg-gray-950 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-lg w-full">
            <h3 class="text-xl font-bold text-gray-200 mb-4 text-center">Link einf√ºgen</h3>
            
            <p class="text-gray-300 mb-4 text-center">Geben Sie die URL f√ºr den Link ein.</p>
            <input type="text" id="link-url-input" placeholder="https://beispiel.de" class="w-full p-3 rounded-xl border border-gray-600 bg-gray-900 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 focus:outline-none">
            <div class="mt-6 flex justify-end space-x-4">
                <button id="link-cancel-btn" class="calculator-btn text-gray-200 font-medium py-2 px-5 rounded-full">
                    Abbrechen
                </button>
                <button id="link-insert-btn" class="calculator-btn text-white font-medium py-2 px-5 rounded-full">
                    Einf√ºgen
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM-Elemente
        const notesList = document.getElementById('notes-list');
        const noteTitleInput = document.getElementById('note-title-input');
        const noteEditor = document.getElementById('note-editor');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const searchInput = document.getElementById('search-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noNotesMessage = document.getElementById('no-notes-message');

        const boldBtn = document.getElementById('bold-btn');
        const italicBtn = document.getElementById('italic-btn');
        const underlineBtn = document.getElementById('underline-btn');
        const indentBtn = document.getElementById('indent-btn');
        const outdentBtn = document.getElementById('outdent-btn');
        const linkBtn = document.getElementById('link-btn');
        const listDropdownMenu = document.getElementById('list-dropdown-menu');
        const listDropdownBtn = document.getElementById('list-dropdown-btn');
        const listDropdownItems = listDropdownMenu.querySelectorAll('.dropdown-item');
        const sizeDropdownMenu = document.getElementById('size-dropdown-menu');
        const sizeDropdownBtn = document.getElementById('size-dropdown-btn');
        const sizeDropdownItems = sizeDropdownMenu.querySelectorAll('.dropdown-item');

        const colorDropdownMenu = document.getElementById('color-dropdown-menu');
        const colorDropdownBtn = document.getElementById('color-dropdown-btn');
        const colorDropdownItems = colorDropdownMenu.querySelectorAll('.dropdown-item');

        // Sortier-Elemente
        const sortDropdownBtn = document.getElementById('sort-dropdown-btn');
        const sortDropdownMenu = document.getElementById('sort-dropdown-menu');
        const sortDropdownItems = sortDropdownMenu.querySelectorAll('.dropdown-item');
        
        // KONSTANTEN F√úR IMPORT/EXPORT
        const exportBtn = document.getElementById('export-btn');
        const importFileInput = document.getElementById('import-file-input');
        
        // Modal-Elemente
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalText = document.getElementById('modal-text');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        // Link-Modal-Elemente
        const linkModalBackdrop = document.getElementById('link-modal-backdrop');
        const linkUrlInput = document.getElementById('link-url-input');
        const linkInsertBtn = document.getElementById('link-insert-btn');
        const linkCancelBtn = document.getElementById('link-cancel-btn');

        let notesData = [];
        let editingNoteId = null;
        let savedRange; // Zum Speichern der Auswahl
        let currentSortMethod = 'unsorted';
        
        // Speicherschl√ºssel als Konstante definieren
        const NOTES_STORAGE_KEY = 'notes';

        const colorMap = {
            'red': '#ff0000',
            'green': '#008000',
            'blue': '#3b82f6', // Etwas helleres Blau, das gut auf dem dunklen Hintergrund sichtbar ist
            'yellow': '#ffff00',
            'white': '#ffffff'
        };
        const sizeMap = {
            '1': 'Klein',
            '3': 'Mittel',
            '5': 'Gro√ü'
        };

        // Drag-and-Drop-Variablen
        let draggedItem = null;

        // ******************************************************
        // ** HELPER FUNKTIONEN **
        // ******************************************************

        /**
         * Konvertiert einen RGB-Farbstring in einen Hex-String.
         * N√∂tig, da document.queryCommandValue('foreColor') oft RGB zur√ºckgibt.
         */
        const rgbToHex = (rgb) => {
            const matches = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!matches) return rgb; // Wenn keine RGB-Daten, gib den urspr√ºnglichen Wert zur√ºck
            const hex = (x) => ("0" + parseInt(x).toString(16)).slice(-2);
            return "#" + hex(matches[1]) + hex(matches[2]) + hex(matches[3]);
        };

        // ******************************************************
        // ** MODAL LOGIK **
        // ******************************************************

        const showModal = (message, showCancelButton = false) => {
            return new Promise(resolve => {
                modalText.textContent = message;
                modalCancelBtn.style.display = showCancelButton ? 'inline-block' : 'none';
                modalBackdrop.classList.remove('hidden');

                const confirmHandler = () => {
                    modalBackdrop.classList.add('hidden');
                    resolve(true);
                };

                const cancelHandler = () => {
                    modalBackdrop.classList.add('hidden');
                    resolve(false);
                };

                modalConfirmBtn.onclick = confirmHandler;
                modalCancelBtn.onclick = cancelHandler;
            });
        };

        const showLinkModal = () => {
            return new Promise(resolve => {
                linkUrlInput.value = '';
                linkModalBackdrop.classList.remove('hidden');

                const insertHandler = () => {
                    linkModalBackdrop.classList.add('hidden');
                    resolve(linkUrlInput.value);
                };

                const cancelHandler = () => {
                    linkModalBackdrop.classList.add('hidden');
                    resolve(null);
                };

                // Einmalige Event Listener, um Konflikte zu vermeiden
                linkInsertBtn.onclick = insertHandler;
                linkCancelBtn.onclick = cancelHandler;
                
                // Fokus auf das Eingabefeld, sobald das Modal ge√∂ffnet wird
                linkUrlInput.focus();
            });
        };


        // ******************************************************
        // ** SELECTION/FOCUS LOGIK (WICHTIG f√ºr Toolbar) **
        // ******************************************************

        const getSelectionRange = () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                return selection.getRangeAt(0);
            }
            return null;
        };

        const saveSelection = () => {
            savedRange = getSelectionRange();
        };

        const restoreSelection = () => {
            if (savedRange) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange);
            }
        };

        /**
         * Findet das √ºbergeordnete Block-Element des aktuellen Cursors/Auswahl.
         */
        const getCurrentBlockElement = (selection) => {
            if (!selection || selection.rangeCount === 0) return null;
            let node = selection.anchorNode;
            
            // Wenn es ein Textknoten ist, gehe zum √ºbergeordneten Element
            if (node.nodeType === Node.TEXT_NODE) {
                node = node.parentNode;
            }

            // Suche nach einem Block-Element innerhalb des Editors
            while (node && node !== noteEditor) {
                // Pr√ºfe auf g√§ngige Block-Tags oder Listenelemente
                if (['P', 'DIV', 'H1', 'H2', 'H3', 'LI'].includes(node.tagName)) {
                    return node;
                }
                node = node.parentNode;
            }
            return null;
        };


        /**
         * F√ºhrt einen Formatierungsbefehl aus und stellt den Fokus in den Editor zur√ºck.
         * @param {string} command - Der execCommand-Befehl.
         * @param {string} value - Der Wert f√ºr den execCommand-Befehl.
         */
        const executeFormatAndRestore = (command, value = null) => {
            // WICHTIG: Auswahl wiederherstellen und Fokus setzen VOR execCommand
            restoreSelection();
            noteEditor.focus();

            // F√ºhre den Formatierungsbefehl aus
            document.execCommand(command, false, value);

            // Auswahl/Range erneut speichern, falls sich die Auswahl ge√§ndert hat
            saveSelection();

            // Toolbar-Status aktualisieren
            updateToolbarState();
        };

        const executeLinkCommand = async () => {
            // 1. Auswahl speichern
            saveSelection();
            
            // 2. Modal anzeigen und auf URL warten
            const url = await showLinkModal();

            // 3. Auswahl wiederherstellen
            restoreSelection();

            if (url) {
                // F√ºhrt den Link-Befehl aus und ersetzt die aktuelle Auswahl
                document.execCommand('createLink', false, url);

                // Manuelle Korrektur f√ºr target="_blank"
                const selection = window.getSelection();
                const node = selection.anchorNode;

                // Versuche, das umgebende A-Tag zu finden
                let linkElement = node.nodeType === Node.TEXT_NODE ? node.parentNode : node;
                while (linkElement && linkElement !== noteEditor && linkElement.tagName !== 'A') {
                    linkElement = linkElement.parentNode;
                }
                if (linkElement && linkElement.tagName === 'A') {
                    linkElement.setAttribute('target', '_blank');
                }
            }
            
            // 4. Fokus in den Editor zur√ºcksetzen
            noteEditor.focus();
            updateToolbarState();
        };


        // ******************************************************
        // ** LISTE (AUFZ√ÑHLUNG) LOGIK **
        // ******************************************************

        /**
         * F√ºhrt die Listenaktion durch (native execCommand + manuelle Stil-Anpassung).
         */
        const toggleList = (targetStyle) => {
            restoreSelection();
            noteEditor.focus();

            const isOrdered = targetStyle === 'decimal';
            const command = isOrdered ? 'insertOrderedList' : 'insertUnorderedList';

            // 1. F√ºhre den Befehl aus (aktiviert/deaktiviert die Liste oder wechselt den Typ)
            document.execCommand(command, false, null);

            // 2. Manuelle Anpassung f√ºr Listen-Stile (UL und OL)
            // Finde das √ºbergeordnete Listen-Element (UL oder OL)
            const selection = window.getSelection();
            let listElement = getCurrentBlockElement(selection);

            if (listElement && listElement.tagName === 'LI') {
                listElement = listElement.parentNode;
            }

            if (listElement && (listElement.tagName === 'UL' || listElement.tagName === 'OL')) {
                // Entferne alle style-Attribute, um mit CSS zu arbeiten
                listElement.removeAttribute('style');

                // Setze den korrekten Listentyp-Stil
                if (listElement.tagName === 'UL' && targetStyle !== 'decimal') {
                    listElement.style.listStyleType = targetStyle;
                }
                if (listElement.tagName === 'OL' && targetStyle === 'decimal') {
                    listElement.style.listStyleType = targetStyle;
                }
            }

            saveSelection();
            updateToolbarState();
        };

        const updateListDropdown = (selection) => {
            let listType = 'Aufz√§hlung';
            let listFound = false;
            let currentBlock = getCurrentBlockElement(selection);
            
            // Gehe vom aktuellen Block bis zum Editor-Rand nach oben
            while (currentBlock && currentBlock !== noteEditor) {
                if (currentBlock.tagName === 'LI') {
                    listFound = true;
                    // Finde das √ºbergeordnete UL/OL, um den Stil zu bestimmen
                    let parentList = currentBlock.parentNode;
                    if (parentList.tagName === 'UL') {
                        listType = parentList.style.listStyleType || 'disc';
                        break;
                    } else if (parentList.tagName === 'OL') {
                        listType = 'decimal';
                        break;
                    }
                }
                currentBlock = currentBlock.parentNode;
            }

            // Setze den Button-Text und die aktive Klasse
            listDropdownItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.value === listType) {
                    item.classList.add('active');
                    if (listType === 'decimal') listDropdownBtn.textContent = 'Nummerierung';
                    else if (listType === 'disc') listDropdownBtn.textContent = 'Punkte';
                    else if (listType === 'circle') listDropdownBtn.textContent = 'Kreise';
                    else listDropdownBtn.textContent = 'Aufz√§hlung';
                }
            });

            // Wenn keine Liste aktiv ist, zeige den Standardtext
            if (!listFound) {
                listDropdownBtn.textContent = 'Aufz√§hlung';
            }

            // Setze den aktiven Zustand f√ºr den Dropdown-Button (nicht den Dropdown-Men√º-Zustand!)
            listDropdownBtn.classList.toggle('active', listFound);
        };


        // ******************************************************
        // ** TOOLBAR STATUS LOGIK **
        // ******************************************************

        /**
         * Aktualisiert den visuellen Zustand der Toolbar-Buttons basierend auf der aktuellen Cursor-Position.
         */
        const updateToolbarState = () => {
            const selection = window.getSelection();

            // F√úR FOKUS/CURSOR R√úCKKEHR: Speichere die Auswahl bei MouseUp oder KeyUp
            if (document.activeElement === noteEditor) {
                saveSelection();
            }

            if (selection.rangeCount === 0 || !noteEditor.contains(selection.anchorNode)) {
                // Alle Buttons/Dropdowns de-aktivieren, wenn der Fokus nicht im Editor ist
                document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.dropdown-item').forEach(item => item.classList.remove('active'));
                
                // Reset Dropdown Button Text
                listDropdownBtn.textContent = 'Aufz√§hlung';
                sizeDropdownBtn.textContent = 'Schriftgr√∂√üe';
                colorDropdownBtn.textContent = 'Schriftfarbe';
                return;
            }

            // Text-Formate (B/I/U/Link)
            boldBtn.classList.toggle('active', document.queryCommandState('bold'));
            italicBtn.classList.toggle('active', document.queryCommandState('italic'));
            underlineBtn.classList.toggle('active', document.queryCommandState('underline'));
            linkBtn.classList.toggle('active', document.queryCommandState('createLink'));
            
            // NEU: Indent/Outdent Verf√ºgbarkeit (nur aktiv, wenn in einer Liste)
            const currentBlock = getCurrentBlockElement(selection);
            const isInsideList = currentBlock && currentBlock.tagName === 'LI';
            
            indentBtn.classList.toggle('active', isInsideList);
            outdentBtn.classList.toggle('active', isInsideList);
            
            // Aufz√§hlungs-Buttons (LI, UL, OL)
            updateListDropdown(selection);

            // Schriftgr√∂√üe
            const fontSizeValue = document.queryCommandValue('fontSize');
            let currentSize = sizeMap[fontSizeValue] || 'Schriftgr√∂√üe';

            sizeDropdownItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.value === fontSizeValue) {
                    item.classList.add('active');
                    currentSize = item.textContent;
                }
            });
            sizeDropdownBtn.textContent = currentSize;
            
            // Schriftfarbe
            let colorValue = document.queryCommandValue('foreColor');
            let currentColor = 'Schriftfarbe';

            if (colorValue) {
                // RGB in Hex umwandeln, falls n√∂tig
                const hexColor = rgbToHex(colorValue).toLowerCase();

                for (const [key, value] of Object.entries(colorMap)) {
                    if (value.toLowerCase() === hexColor) {
                        currentColor = key.charAt(0).toUpperCase() + key.slice(1);
                        break;
                    }
                }
            }

            colorDropdownItems.forEach(item => {
                item.classList.remove('active');
                const targetColor = colorMap[item.dataset.value] || item.dataset.value;
                if (rgbToHex(colorValue).toLowerCase() === targetColor.toLowerCase()) {
                    item.classList.add('active');
                }
            });
            colorDropdownBtn.textContent = currentColor;
        };


        // ******************************************************
        // ** DATEN LOGIK (Laden/Speichern/Rendern) **
        // ******************************************************

        const saveNotesToLocal = () => {
            localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notesData));
        };

        const loadNotesFromLocal = () => {
            loadingIndicator.classList.remove('hidden');
            const storedNotes = localStorage.getItem(NOTES_STORAGE_KEY);
            if (storedNotes) {
                try {
                    notesData = JSON.parse(storedNotes);
                } catch (e) {
                    console.error("Fehler beim Parsen der Notizen:", e);
                    notesData = [];
                }
            }
            // Stelle sicher, dass die Notizen in der richtigen Reihenfolge gerendert werden
            sortNotes(currentSortMethod, false); 
            renderNotes();
            loadingIndicator.classList.add('hidden');
        };

        const saveNote = () => {
            // Entferne HTML-Tags (au√üer erlaubten), aber behalte Struktur f√ºr den Editor-Content
            const rawContent = noteEditor.innerHTML.trim();
            const rawTitle = noteTitleInput.value.trim();

            if (!rawTitle && !rawContent) {
                showModal("Die Notiz ist leer. Bitte geben Sie einen Titel oder Inhalt ein.");
                return;
            }

            const now = new Date().toISOString();
            
            // Sanitize HTML slightly for display/storage consistency
            const sanitizedContent = rawContent.replace(/<br\s*\/?>/gi, '').trim() === '' ? '' : rawContent;

            if (editingNoteId) {
                // Bearbeiten einer bestehenden Notiz
                const noteIndex = notesData.findIndex(n => n.id === editingNoteId);
                if (noteIndex !== -1) {
                    notesData[noteIndex].title = rawTitle;
                    notesData[noteIndex].content = sanitizedContent;
                    notesData[noteIndex].updatedAt = now;
                }
                editingNoteId = null;
            } else {
                // Neue Notiz erstellen
                const newNote = {
                    id: crypto.randomUUID(),
                    title: rawTitle,
                    content: sanitizedContent,
                    createdAt: now,
                    updatedAt: now,
                    order: notesData.length // F√ºgt neue Notiz ans Ende (f√ºr unsortiert)
                };
                notesData.unshift(newNote); // Neue Notizen oben hinzuf√ºgen
            }

            // Aufr√§umen des Editors
            noteTitleInput.value = '';
            noteEditor.innerHTML = '';
            
            // Daten speichern und neu rendern
            saveNotesToLocal();
            // Nach dem Speichern immer nach der aktuellen Sortiermethode sortieren
            sortNotes(currentSortMethod, false); 
            renderNotes();
            
            showModal("Notiz erfolgreich gespeichert!");
        };

        const deleteNote = async (id) => {
            const confirmed = await showModal("Sind Sie sicher, dass Sie diese Notiz l√∂schen m√∂chten?", true);
            if (confirmed) {
                notesData = notesData.filter(note => note.id !== id);
                saveNotesToLocal();
                renderNotes();
                showModal("Notiz gel√∂scht.");
            }
        };

        const editNote = (id, title, content) => {
            // Editor leeren und mit Notiz-Daten f√ºllen
            noteTitleInput.value = title;
            noteEditor.innerHTML = content;
            editingNoteId = id;
            
            // Setze den Cursor ans Ende des Editor-Inhalts
            noteEditor.focus();
            const range = document.createRange();
            range.selectNodeContents(noteEditor);
            range.collapse(false);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Speichere die Auswahl f√ºr die Toolbar-Funktion
            saveSelection();
            updateToolbarState();

            // Scrolle zum Editor
            noteTitleInput.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };


        const renderNotes = (searchTerm = searchInput.value) => {
            const list = notesList;
            list.innerHTML = ''; // Liste leeren
            const term = searchTerm.toLowerCase().trim();

            const filteredNotes = notesData.filter(note => {
                const titleMatch = note.title.toLowerCase().includes(term);
                const contentMatch = note.content.toLowerCase().includes(term);
                return titleMatch || contentMatch;
            });

            if (filteredNotes.length === 0) {
                noNotesMessage.classList.remove('hidden');
                return;
            } else {
                noNotesMessage.classList.add('hidden');
            }

            filteredNotes.forEach(note => {
                const card = createNoteCard(note);
                list.appendChild(card);
            });
        };

        const createNoteCard = (note) => {
            const div = document.createElement('div');
            div.className = `note-card p-4 rounded-xl shadow-lg border-2 mb-4 hover:border-blue-500 transition-all duration-200`;
            div.setAttribute('draggable', currentSortMethod === 'unsorted' ? 'true' : 'false');
            div.dataset.id = note.id;
            div.dataset.order = note.order;
            
            // Formatierung des Datums
            const formatDate = (isoString) => {
                if (!isoString) return 'Unbekannt';
                const date = new Date(isoString);
                return date.toLocaleDateString('de-DE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xl font-semibold text-gray-100">${note.title || 'Ohne Titel'}</h3>
                    <div class="flex space-x-2">
                        <button class="calculator-btn edit-btn text-blue-400 hover:text-blue-300 p-1 rounded-md">Bearbeiten</button>
                        <button class="calculator-btn delete-btn text-red-400 hover:text-red-300 p-1 rounded-md">L√∂schen</button>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mb-3">Zuletzt aktualisiert: ${formatDate(note.updatedAt)}</p>
                <div class="note-content text-gray-300 overflow-hidden" style="max-height: 150px; text-overflow: ellipsis;">
                    ${note.content || '<em class="text-gray-500">Kein Inhalt</em>'}
                </div>
            `;

            div.querySelector('.edit-btn').addEventListener('click', () => editNote(note.id, note.title, note.content));
            div.querySelector('.delete-btn').addEventListener('click', () => deleteNote(note.id));
            
            // Nur Drag-Listener hinzuf√ºgen, wenn Drag erlaubt ist
            if (currentSortMethod === 'unsorted') {
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                div.addEventListener('dragend', handleDragEnd);
            }

            return div;
        };
        
        const sortNotes = (method, doRender = true) => {
            currentSortMethod = method;
            const sortBtnTextMap = {
                'unsorted': 'Unsortiert',
                'newest': 'Datum (neueste zuerst)',
                'oldest': 'Datum (√§lteste zuerst)',
                'title-asc': 'Titel (A-Z)',
                'title-desc': 'Titel (Z-A)'
            };
            
            // Aktualisiere den Button-Text und die aktive Klasse im Dropdown
            sortDropdownBtn.textContent = `Sortieren nach: ${sortBtnTextMap[method]}`;
            sortDropdownItems.forEach(item => {
                item.classList.toggle('active', item.dataset.value === method);
            });

            // Sortierlogik
            if (method === 'unsorted') {
                // Sortiere nach der gespeicherten 'order'-Eigenschaft
                notesData.sort((a, b) => a.order - b.order);
            } else if (method === 'newest') {
                notesData.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            } else if (method === 'oldest') {
                notesData.sort((a, b) => new Date(a.updatedAt) - new Date(b.updatedAt));
            } else if (method === 'title-asc') {
                notesData.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            } else if (method === 'title-desc') {
                notesData.sort((a, b) => (b.title || '').localeCompare(a.title || ''));
            }

            if (doRender) {
                renderNotes();
            }
            // Speichere, um die aktuelle Sortiermethode zu erhalten
            saveNotesToLocal();
        };


        // ******************************************************
        // ** DRAG & DROP LOGIK (NUR f√ºr "Unsortiert") **
        // ******************************************************

        const handleDragStart = (e) => {
            draggedItem = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
        };

        const handleDragOver = (e) => {
            if (currentSortMethod !== 'unsorted') return;
            e.preventDefault(); // Erm√∂glicht das Ablegen
            e.dataTransfer.dropEffect = 'move';
            
            const target = e.target.closest('.note-card');
            if (target && target !== draggedItem) {
                const rect = target.getBoundingClientRect();
                const next = (e.clientY - rect.top) / rect.height > 0.5;
                
                // F√ºge das Dragging-Element vor oder nach dem Ziel-Element ein
                if (next) {
                    notesList.insertBefore(draggedItem, target.nextSibling);
                } else {
                    notesList.insertBefore(draggedItem, target);
                }
            }
        };

        const handleDrop = (e) => {
            if (currentSortMethod !== 'unsorted') return;
            e.preventDefault();
        };

        const handleDragEnd = (e) => {
            if (currentSortMethod !== 'unsorted') return;
            e.target.classList.remove('dragging');
            
            // Aktualisiere die 'order'-Eigenschaft basierend auf der neuen DOM-Reihenfolge
            const updatedNotesData = [];
            let newOrder = 0;
            notesList.querySelectorAll('.note-card').forEach(card => {
                const noteId = card.dataset.id;
                const note = notesData.find(n => n.id === noteId);
                if (note) {
                    note.order = newOrder++;
                    updatedNotesData.push(note);
                }
            });

            notesData = updatedNotesData;
            saveNotesToLocal();
        };


        // ******************************************************
        // ** IMPORT/EXPORT LOGIK **
        // ******************************************************

        const exportNotes = () => {
            if (notesData.length === 0) {
                showModal("Es gibt keine Notizen zum Exportieren.");
                return;
            }
            
            const dataStr = JSON.stringify(notesData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `offline-notizen-export-${new Date().toISOString().split('T')[0]}.json`;
            
            // F√ºhre den Klick aus und entferne das Element
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // showModal("Notizen wurden erfolgreich als JSON-Datei exportiert."); // <<< ENTFERNT
        };

        const importNotes = (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        await showModal("Import fehlgeschlagen: Die Datei enth√§lt keine g√ºltige Notizen-Liste.");
                        return;
                    }
                    
                    const confirmed = await showModal("M√∂chten Sie die importierten Notizen zu Ihren bestehenden Notizen hinzuf√ºgen? (Abbrechen ersetzt alle aktuellen Notizen)", true);
                    
                    let newNotes = importedData.map(note => ({
                        // Erstelle neue IDs f√ºr importierte Notizen, um Konflikte zu vermeiden
                        id: crypto.randomUUID(), 
                        title: note.title || '',
                        content: note.content || '',
                        // Aktualisiere die Zeitstempel auf jetzt, um sie als "neu" zu kennzeichnen
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        // Setze die Reihenfolge auf eine neue, fortlaufende Nummer
                        order: -1 // Wird sp√§ter aktualisiert
                    }));

                    if (confirmed) {
                        // Hinzuf√ºgen
                        notesData = [...notesData, ...newNotes];
                    } else {
                        // Ersetzen
                        notesData = newNotes;
                    }

                    // Stelle sicher, dass 'order' f√ºr alle Notizen im unsortierten Zustand korrekt ist
                    notesData.forEach((note, index) => note.order = index);

                    saveNotesToLocal();
                    // Stelle die Sortierung auf "unsortiert" zur√ºck, da die Reihenfolge neu definiert wurde
                    sortNotes('unsorted', false); 
                    renderNotes();
                    await showModal(`${importedData.length} Notizen erfolgreich importiert.`);
                    
                } catch (error) {
                    await showModal(`Fehler beim Importieren der Datei: ${error.message}`);
                }
            };
            reader.readAsText(file);
            
            // Setze den Dateieingabewert zur√ºck, damit dieselbe Datei erneut importiert werden kann
            event.target.value = ''; 
        };


        // ******************************************************
        // ** EVENT LISTENER **
        // ******************************************************

        // Toolbar Button Event Listener (B/I/U/Einr√ºcken/Ausr√ºcken)
        boldBtn.addEventListener('click', () => executeFormatAndRestore('bold'));
        italicBtn.addEventListener('click', () => executeFormatAndRestore('italic'));
        underlineBtn.addEventListener('click', () => executeFormatAndRestore('underline'));
        indentBtn.addEventListener('click', () => executeFormatAndRestore('indent'));
        outdentBtn.addEventListener('click', () => executeFormatAndRestore('outdent'));
        linkBtn.addEventListener('click', executeLinkCommand);
        
        // Toolbar Dropdown Toggles
        listDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            listDropdownMenu.classList.toggle('active');
            sizeDropdownMenu.classList.remove('active');
            colorDropdownMenu.classList.remove('active');
        });
        sizeDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            sizeDropdownMenu.classList.toggle('active');
            listDropdownMenu.classList.remove('active');
            colorDropdownMenu.classList.remove('active');
        });
        colorDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            colorDropdownMenu.classList.toggle('active');
            listDropdownMenu.classList.remove('active');
            sizeDropdownMenu.classList.remove('active');
        });
        sortDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            sortDropdownMenu.classList.toggle('active');
        });
        
        // List Dropdown Items
        listDropdownItems.forEach(item => item.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleList(item.dataset.value);
            listDropdownMenu.classList.remove('active');
        }));
        
        // Size Dropdown Items
        sizeDropdownItems.forEach(item => item.addEventListener('click', (e) => {
            e.stopPropagation();
            executeFormatAndRestore('fontSize', item.dataset.value);
            sizeDropdownMenu.classList.remove('active');
        }));

        // Color Dropdown Items
        colorDropdownItems.forEach(item => item.addEventListener('click', (e) => {
            e.stopPropagation();
            // Standardm√§√üig wird der Wert als Name oder Hex-Code gesendet
            executeFormatAndRestore('foreColor', colorMap[item.dataset.value] || item.dataset.value);
            colorDropdownMenu.classList.remove('active');
        }));

        // Sort Dropdown Items
        sortDropdownItems.forEach(item => item.addEventListener('click', (e) => {
            e.stopPropagation();
            sortNotes(item.dataset.value);
            sortDropdownMenu.classList.remove('active');
        }));

        // Globale Klick-Events zum Schlie√üen von Dropdowns
        document.addEventListener('click', () => {
            listDropdownMenu.classList.remove('active');
            sizeDropdownMenu.classList.remove('active');
            colorDropdownMenu.classList.remove('active');
            sortDropdownMenu.classList.remove('active');
        });
        
        // Speichern und Suchen
        saveNoteBtn.addEventListener('click', saveNote);
        searchInput.addEventListener('input', (e) => renderNotes(e.target.value));
        
        // Import/Export
        exportBtn.addEventListener('click', exportNotes);
        importFileInput.addEventListener('change', importNotes);
        
        // Event listener zur Aktualisierung des Toolbar-Zustands bei Fokuswechsel
        noteEditor.addEventListener('focus', updateToolbarState);
        noteEditor.addEventListener('blur', updateToolbarState);
        noteEditor.addEventListener('input', updateToolbarState);
        
        // Maus- und Tastatur-Events zur Aktualisierung der Toolbar
        noteEditor.addEventListener('mouseup', updateToolbarState); 
        noteEditor.addEventListener('keyup', updateToolbarState);


        // Initial loading of notes
        window.addEventListener('load', loadNotesFromLocal);
    </script>
</body>
</html>
