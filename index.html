<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Meine Offline-Notizen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        :root{
            /* BASICS */
            --btn-gray: #4b5563;
 /* bg-gray-600 */
            --btn-blue: #2563eb;
 /* bg-blue-600 */
            --btn-green: #10b981;
 /* bg-green-600 */
            --btn-yellow: #fbbf24;
 /* bg-yellow-600 */
            --accent: #6aa1ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
        }

        .note-card {
            background-color: #1a202c;
 border-color: #2d3748;
            cursor: grab;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .note-card.dragging {
            opacity: 0.5;
 transform: scale(0.95);
        }
        #note-editor {
            min-height: 100px;
 padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #4a5568; 
            background-color: #1a202c;
            color: #ffffff;
            outline: none; 
            transition: all 0.3s;
        }
        
        #note-editor:focus {
            outline: none !important;
        }

        /* ----------------------------------------------------- */
        /* --- RECHNER-PRINZIP CSS-REGELN FÜR ALLE BUTTONS --- */
        /* ----------------------------------------------------- */
        .calculator-btn, label[for="import-file-input"] {
            -webkit-tap-highlight-color: transparent;
 touch-action: manipulation;
            transition: transform .06s ease, background-color 0.2s ease;
            border: none;
        }

        .calculator-btn:active, label[for="import-file-input"]:active {
            transform: scale(0.96);
        }

        .calculator-btn:focus, label[for="import-file-input"]:focus {
            outline: none !important;
 box-shadow: none !important;
        }

        .calculator-btn:focus-visible, label[for="import-file-input"]:focus-visible {
            outline: 2px solid var(--accent);
 outline-offset: 2px;
        }
        
        /* Graue Buttons (Toolbar, Sort, Modal-Cancel) */
        .toolbar-btn, .dropdown-item, #sort-dropdown-btn, #modal-cancel-btn, #link-cancel-btn {
            background-color: var(--btn-gray) !important;
        }
        
        .toolbar-btn:hover:not(.active), .dropdown-item:hover:not(.active), #sort-dropdown-btn:hover, #modal-cancel-btn:hover, #link-cancel-btn:hover {
            background-color: var(--btn-gray) !important;
        }
        
        .toolbar-btn:active, .dropdown-item:active, #sort-dropdown-btn:active, #modal-cancel-btn:active, #link-cancel-btn:active {
             background-color: #374151 !important;
 /* bg-gray-700 */
        }

        /* WICHTIG: Blauer Hintergrund für aktive Toolbar-Buttons und Dropdown-Elemente */
        .toolbar-btn.active, .dropdown-item.active {
            background-color: var(--btn-blue) !important;
 color: #ffffff !important;
        }

        /* Blaue Buttons (Save, Modal-Confirm, Link-Insert) */
        #save-note-btn, #modal-confirm-btn, #link-insert-btn {
            background-color: var(--btn-blue) !important;
        }
        #save-note-btn:hover, #modal-confirm-btn:hover, #link-insert-btn:hover {
            background-color: #1d4ed8 !important;
 /* bg-blue-700 */
        }
        #save-note-btn:active, #modal-confirm-btn:active, #link-insert-btn:active {
            background-color: #1e40af !important;
 /* bg-blue-800 */
        }

        /* Grüne Buttons (Export) */
        #export-btn {
            background-color: var(--btn-green) !important;
        }
        #export-btn:hover {
            background-color: #059669 !important;
 /* bg-green-700 */
        }
        #export-btn:active {
            background-color: #047857 !important;
 /* bg-green-800 */
        }
        
        /* Gelbe Buttons (Import) */
        label[for="import-file-input"] {
            background-color: var(--btn-yellow) !important;
        }
        label[for="import-file-input"]:hover {
             background-color: #f59e0b !important;
 /* bg-yellow-600/700 */
        }
        label[for="import-file-input"]:active {
            background-color: #a16207 !important;
 /* bg-yellow-800 */
        }
        
        /* Dropdown Menü Styling */
        .dropdown-menu {
            position: absolute;
 z-index: 10;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            background-color: #374151;
 /* bg-gray-700 */
            border-radius: 0.5rem;
            padding: 0.25rem;
 box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            width: max-content;
            min-width: 100%;
        }

        .dropdown-menu.active {
            display: flex;
        }

        #note-editor:empty:before {
            content: attr(placeholder);
 color: #718096;
            pointer-events: none;
            display: block;
        }
        
        /* Spezielle Regel für Link-Färbung im Editor */
        #note-editor a {
            color: #3b82f6;
 /* Tailwind blue-500 */
            text-decoration: underline;
        }
        
        /* --- STABILISIERTE LISTE-STYLES --- */
        #note-editor ul, #note-editor ol, .note-card ul, .note-card ol {
            margin: 0;
 padding-left: 1.5rem; 
        }
        
        #note-editor li, .note-card li {
            color: #ffffff !important;
        }

        #note-editor li::marker, .note-card li::marker {
            color: #ffffff !important;
        }
        
        /* ERGÄNZUNG: Spezielle CSS-Regeln für die Listentypen (aus besser2.txt) */
        /* Kreise (Hohle Kreise) */
        #note-editor ul[style*="list-style-type: circle"], .note-card ul[style*="list-style-type: circle"] {
            list-style-type: circle !important;
        }
        
        /* Punkte (Gefüllte Scheiben/Discs) */
        #note-editor ul[style*="list-style-type: disc"], .note-card ul[style*="list-style-type: disc"] {
            list-style-type: disc !important;
        }
        
        /* Fallback für ul ohne Stil */
        #note-editor ul:not([style]), .note-card ul:not([style]) {
             list-style-type: disc !important;
        }
        
        #note-editor ol, .note-card ol {
            list-style-type: decimal;
        }
    </style>
</head>
<body class="bg-black min-h-screen p-4 flex items-center justify-center">

    <div class="bg-gray-900 p-6 rounded-3xl shadow-2xl w-full max-w-4xl transition-all duration-300 transform scale-100">
        <header class="mb-6 border-b pb-4 border-gray-700">
            <h1 class="text-4xl font-extrabold text-gray-100 text-center">
                Meine Offline-Notizen
            </h1>
        </header>

        <div class="mb-6 p-4 bg-gray-800 rounded-2xl shadow-inner">
            <h2 class="text-2xl font-bold text-gray-200 mb-4">Neue Notiz erstellen</h2>
            
            <input type="text" id="note-title-input" placeholder="Titel der Notiz (optional)" class="w-full p-3 mb-4 rounded-xl border border-gray-600 bg-gray-800 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 focus:outline-none">
  
          
      
       <div class="flex flex-wrap gap-2 mb-4 p-2 bg-gray-700 rounded-xl">
                <button id="bold-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200 font-bold">B</button>
                <button id="italic-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200 italic">I</button>
                <button id="underline-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200 underline">U</button>
                
  
   
                <div class="relative inline-block">
                    <button id="list-dropdown-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
                        Aufzählung
                    </button>
          
           
                    <div id="list-dropdown-menu" class="dropdown-menu">
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="decimal">Nummerierung</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="disc">Punkte</button>
           
              <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="circle">Kreise</button>
                    </div>
                </div>

                <div class="relative inline-block">
                    <button id="size-dropdown-btn" class="calculator-btn toolbar-btn p-2 
 rounded-lg text-gray-200">
                        Schriftgröße
                    </button>
                    <div id="size-dropdown-menu" class="dropdown-menu">
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="1">Klein</button>
 
              
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="3">Mittel</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="5">Groß</button>
                    </div>
   
                 </div>

              
                <div class="relative inline-block">
                    <button id="color-dropdown-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
                        Schriftfarbe
     
                 </button>
                    <div id="color-dropdown-menu" class="dropdown-menu">
 
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg text-white" data-value="white">Weiß</button>
                        <button class="calculator-btn dropdown-item w-full text-left 
 px-4 py-2 rounded-lg text-red-500" data-value="red">Rot</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg text-green-500" data-value="green">Grün</button>
  
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg text-blue-500" data-value="blue">Blau</button>
                        <button class="calculator-btn dropdown-item w-full 
 text-left px-4 py-2 rounded-lg text-yellow-500" data-value="yellow">Gelb</button>
                    </div>
                
                </div>

                <button id="link-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
                    Link
 
                </button>

                <button id="indent-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
                    Einrücken
                </button>
                <button id="outdent-btn" class="calculator-btn toolbar-btn p-2 rounded-lg text-gray-200">
     
                Ausrücken
                </button>
            </div>
     
        
          
            <div id="note-editor" class="w-full rounded-xl border border-gray-600 bg-gray-800 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none transition-all duration-300" contenteditable="true" placeholder="Schreiben Sie hier Ihre neue Notiz..."></div>
  
           
            <div class="mt-4 flex justify-end space-x-2">
                <button id="save-note-btn" class="calculator-btn text-white font-medium py-2 px-5 
rounded-full shadow-lg transform">
                    Notiz speichern
                </button>
            
 </div>
    
        </div>

        <div class="mb-6 flex 
 flex-col md:flex-row gap-4">
            <input type="text" id="search-input" placeholder="Notizen durchsuchen..." class="w-full md:w-1/3 p-3 rounded-xl border border-gray-600 bg-gray-800 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 focus:outline-none">
            
            <div class="flex flex-col sm:flex-row gap-4 w-full md:w-2/3">
                
                <div class="relative w-full sm:w-1/2">
   
                  <button 
                        id="sort-dropdown-btn" 
                        class="calculator-btn w-full p-3 rounded-xl border border-gray-600 bg-gray-800 text-gray-100 text-left">
                        Sortieren 
 nach: Unsortiert
                    </button>
                    <div id="sort-dropdown-menu" class="dropdown-menu">
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg active" data-value="unsorted">Unsortiert</button>
                        
 <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="newest">Datum (neueste zuerst)</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="oldest">Datum (älteste zuerst)</button>
                        <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="title-asc">Titel (A-Z)</button>
                       
  <button class="calculator-btn dropdown-item w-full text-left px-4 py-2 rounded-lg" data-value="title-desc">Titel (Z-A)</button>
                    </div>
                </div>

                <div class="flex gap-2 w-full sm:w-1/2">
                    <button id="export-btn" class="calculator-btn w-1/2 p-3 rounded-xl border border-gray-600 text-white font-medium">
     
                    Export 💾
                    </button>
                    <label for="import-file-input" 
                        class="w-1/2 p-3 rounded-xl border border-gray-600 text-white font-medium cursor-pointer text-center flex items-center justify-center">
   
                      Import 📥
                    </label>
                    <input type="file" id="import-file-input" accept="application/json" style="display: none;">
                </div>
            </div>
     
    </div>

        <div id="notes-list" class="space-y-4">
        </div>

        <div id="loading-indicator" class="text-center 
text-gray-400 mt-8 hidden">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
            <p class="mt-2">Notizen werden geladen...</p>
        </div>

        <div id="no-notes-message" class="text-center text-gray-400 mt-8 hidden">
 
            <p>Sie haben noch keine Notizen.
 Fügen Sie eine neue hinzu, um zu beginnen!</p>
        </div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-gray-950 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full">
            <p id="modal-text" class="text-lg font-semibold text-gray-200 text-center mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="modal-confirm-btn" class="calculator-btn text-white 
 
font-medium py-2 px-5 rounded-full">
                    OK
                </button>
                <button id="modal-cancel-btn" class="calculator-btn text-gray-200 font-medium py-2 px-5 rounded-full hidden">
                    Abbrechen
           
      
           </button>
            </div>
        </div>
    </div>

    <div id="link-modal-backdrop" class="fixed inset-0 bg-gray-950 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-lg w-full">
            <h3 class="text-xl font-bold text-gray-200 mb-4 text-center">Link einfügen</h3>
            
        
     <p 
class="text-gray-300 mb-4 text-center">Geben Sie die URL für den Link ein.</p>
            <input type="text" id="link-url-input" placeholder="https://beispiel.de" class="w-full p-3 rounded-xl border border-gray-600 bg-gray-900 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 focus:outline-none">
            <div class="mt-6 flex justify-end space-x-4">
                <button id="link-cancel-btn" class="calculator-btn text-gray-200 font-medium py-2 px-5 rounded-full">
                   
  Abbrechen
 
                </button>
                <button id="link-insert-btn" class="calculator-btn text-white font-medium py-2 px-5 rounded-full">
                    Einfügen
                </button>
            </div>
        </div>
   
 
    </div>

    <script>
        // DOM-Elemente
        const notesList = document.getElementById('notes-list');
        const noteTitleInput = document.getElementById('note-title-input');
        const noteEditor = document.getElementById('note-editor');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const searchInput = document.getElementById('search-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noNotesMessage = document.getElementById('no-notes-message');

        const boldBtn = document.getElementById('bold-btn');
        const italicBtn = document.getElementById('italic-btn');
        const underlineBtn = document.getElementById('underline-btn');
        const indentBtn = document.getElementById('indent-btn');
        const outdentBtn = document.getElementById('outdent-btn');
        const linkBtn = document.getElementById('link-btn');

        const listDropdownMenu = document.getElementById('list-dropdown-menu');
        const listDropdownBtn = document.getElementById('list-dropdown-btn');
        const listDropdownItems = listDropdownMenu.querySelectorAll('.dropdown-item');

        const sizeDropdownMenu = document.getElementById('size-dropdown-menu');
        const sizeDropdownBtn = document.getElementById('size-dropdown-btn');
        const sizeDropdownItems = sizeDropdownMenu.querySelectorAll('.dropdown-item');

        const colorDropdownMenu = document.getElementById('color-dropdown-menu');
        const colorDropdownBtn = document.getElementById('color-dropdown-btn');
        const colorDropdownItems = colorDropdownMenu.querySelectorAll('.dropdown-item');

        // Sortier-Elemente
        const sortDropdownBtn = document.getElementById('sort-dropdown-btn');
        const sortDropdownMenu = document.getElementById('sort-dropdown-menu');
        const sortDropdownItems = sortDropdownMenu.querySelectorAll('.dropdown-item');

        // KONSTANTEN FÜR IMPORT/EXPORT
        const exportBtn = document.getElementById('export-btn');
        const importFileInput = document.getElementById('import-file-input');

        // Modal-Elemente
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalText = document.getElementById('modal-text');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        // Link-Modal-Elemente
        const linkModalBackdrop = document.getElementById('link-modal-backdrop');
        const linkUrlInput = document.getElementById('link-url-input');
        const linkInsertBtn = document.getElementById('link-insert-btn');
        const linkCancelBtn = document.getElementById('link-cancel-btn');

        let notesData = [];
        let editingNoteId = null;
        let savedRange; // Zum Speichern der Auswahl
        let currentSortMethod = 'unsorted';
        
        // Speicherschlüssel als Konstante definieren
        const NOTES_STORAGE_KEY = 'notes';

        const colorMap = {
            'red': '#ff0000',
            'green': '#008000',
            'blue': '#3b82f6', // Etwas helleres Blau, das gut auf dem dunklen Hintergrund sichtbar ist
            'yellow': '#ffff00',
            'white': '#ffffff'
        };

        const sizeMap = {
            '1': 'Klein',
            '3': 'Mittel',
            '5': 'Groß'
        };

        // Drag-and-Drop-Variablen
        let draggedItem = null;

        // ******************************************************
        // ** HELPER FUNKTIONEN **
        // ******************************************************

        /**
         * Konvertiert einen RGB-Farbstring in einen Hex-String.
         * Nötig, da document.queryCommandValue('foreColor') oft RGB zurückgibt.
         */
        const rgbToHex = (rgb) => {
            const matches = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!matches) return rgb; // Wenn keine RGB-Daten, gib den ursprünglichen Wert zurück
            const hex = (x) => ("0" + parseInt(x).toString(16)).slice(-2);
            return "#" + hex(matches[1]) + hex(matches[2]) + hex(matches[3]);
        };

        // ******************************************************
        // ** MODAL LOGIK **
        // ******************************************************

        const showModal = (message, showCancelButton = false) => {
            return new Promise(resolve => {
                modalText.textContent = message;
                modalCancelBtn.style.display = showCancelButton ? 'inline-block' : 'none';
                modalBackdrop.classList.remove('hidden');

                const confirmHandler = () => {
                    modalBackdrop.classList.add('hidden');
                    resolve(true);
                };

                const cancelHandler = () => {
                    modalBackdrop.classList.add('hidden');
                    resolve(false);
                };

                modalConfirmBtn.onclick = confirmHandler;
                modalCancelBtn.onclick = cancelHandler;
            });
        };

        const showLinkModal = () => {
            return new Promise(resolve => {
                linkUrlInput.value = '';
                linkModalBackdrop.classList.remove('hidden');

                const insertHandler = () => {
                    linkModalBackdrop.classList.add('hidden');
                    resolve(linkUrlInput.value);
                };

                const cancelHandler = () => {
                    linkModalBackdrop.classList.add('hidden');
                    resolve(null);
                };

                // Einmalige Event Listener, um Konflikte zu vermeiden
                linkInsertBtn.onclick = insertHandler;
                linkCancelBtn.onclick = cancelHandler;
                
                // Fokus auf das Eingabefeld, sobald das Modal geöffnet wird
                linkUrlInput.focus();
            });
        };

        // ******************************************************
        // ** SELECTION/FOCUS LOGIK (WICHTIG für Toolbar) **
        // ******************************************************

        const getSelectionRange = () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                return selection.getRangeAt(0);
            }
            return null;
        };

        const saveSelection = () => {
            savedRange = getSelectionRange();
        };

        const restoreSelection = () => {
            if (savedRange) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange);
                savedRange = null; 
            }
        };

        const collapseSelection = () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                // collapse auf das Ende, um den Cursor zu positionieren
                range.collapse(false); 
                selection.removeAllRanges();
                selection.addRange(range);
            }
        };

        // ******************************************************
        // ** AUFZÄHLUNGSLOGIK (ÜBERNOMMEN VON besser2.txt) **
        // ******************************************************

        /**
         * Findet das nächste Block-Level-Element (p, div, li, hx)
         * in Bezug auf den aktuellen Cursor innerhalb des noteEditor.
         */
        const getCurrentBlockElement = (selection) => {
            if (!selection.rangeCount) return null;
            let node = selection.getRangeAt(0).startContainer;
            
            // Wenn es ein Textknoten ist, gehe zum übergeordneten Element
            if (node.nodeType === Node.TEXT_NODE) {
                node = node.parentNode;
            }
            
            // Finde den nächsten Block-Level-Elternteil (P, DIV, LI)
            while (node && node !== noteEditor) {
                const tagName = node.tagName;
                // Füge DIV hinzu, falls der Editor ein leeres DIV erstellt (z.B. bei Enter)
                if (['P', 'DIV', 'LI', 'H1', 'H2', 'H3'].includes(tagName)) {
                    return node;
                }
                node = node.parentNode;
            }
            
            return null;
        };

        /**
         * Wendet eine benutzerdefinierte Listenformatierung (ul/ol mit Stil) an.
         * @param {string} targetStyle - 'decimal', 'disc', 'circle'
         */
        const toggleCustomList = (targetStyle) => {
            const selection = window.getSelection();
            if (!selection || !noteEditor.contains(selection.anchorNode)) return;

            const currentBlock = getCurrentBlockElement(selection);
            
            // Ermittle den aktuellen Listentyp (UL oder OL), falls vorhanden
            const isCurrentlyLi = currentBlock && currentBlock.tagName === 'LI';
            const currentListType = isCurrentlyLi ? currentBlock.parentNode.tagName : null;

            // 1. ANFANG: KEINE LISTE VORHANDEN ODER WIRKLICH EIN NEUES BLOCK-ELEMENT (P/DIV)
            if (!currentBlock || currentBlock.tagName !== 'LI') {
                const command = targetStyle === 'decimal' ? 'insertOrderedList' : 'insertUnorderedList';
                document.execCommand(command);

                // Nach execCommand befindet sich der Cursor wahrscheinlich in einem LI.
                // Wir müssen den Stil sofort anwenden.
                const newBlock = getCurrentBlockElement(selection); 
                if (newBlock && newBlock.tagName === 'LI') {
                    const parentList = newBlock.parentNode;
                    if (parentList && parentList.tagName === 'UL') {
                        parentList.style.listStyleType = targetStyle;
                    }
                }
                return; // Aktion beendet
            } 
            
            // 2. ZIEL: LISTE AUFHEBEN (LI -> P/DIV)
            if ((targetStyle === 'disc' && currentListType === 'UL' && currentBlock.parentNode.style.listStyleType === 'disc') ||
                (targetStyle === 'circle' && currentListType === 'UL' && currentBlock.parentNode.style.listStyleType === 'circle') ||
                (targetStyle === 'decimal' && currentListType === 'OL')
            ) {
                // Führt Outdent aus, was die Liste auflösen kann
                document.execCommand('outdent'); 
                return;
            }

            // 3. ZIEL: STIL-WECHSEL INNERHALB UL (disc <-> circle)
            if (isCurrentlyLi && currentListType === 'UL' && targetStyle !== 'decimal') {
                const parentList = currentBlock.parentNode;
                const targetMarkerStyle = targetStyle === 'disc' ? 'disc' : targetStyle; 
                // Ändere nur den Stil der Elternliste
                parentList.style.listStyleType = targetMarkerStyle;
                
                // Cursor wiederherstellen
                selection.removeAllRanges();
                const newRange = document.createRange();
                newRange.selectNodeContents(currentBlock);
                newRange.collapse(false);
                selection.addRange(newRange);
                return; // Aktion beendet
            }
            
            // 4. ZIEL: AKTUELL UL ODER OL, ABER ZU ANDERER LISTE WECHSELN (z.B. UL zu OL)
            if (isCurrentlyLi) {
                let command = '';
                if (targetStyle === 'decimal' && currentListType === 'UL') {
                    command = 'insertOrderedList';
                } else if ((targetStyle === 'disc' || targetStyle === 'circle') && currentListType === 'OL') {
                    command = 'insertUnorderedList';
                }

                if (command) {
                    document.execCommand(command);
                    
                    // Wende den Stil nach dem Wechsel an, da der Browser den Standardstil verwendet
                    const newBlock = getCurrentBlockElement(selection);
                    if (newBlock && newBlock.tagName === 'LI') {
                        const parentList = newBlock.parentNode;
                        if (parentList && parentList.tagName === 'UL') {
                            parentList.style.listStyleType = targetStyle; // Wende den Stil an
                        }
                    }
                }
            }
        };

        // ******************************************************
        // ** FORMATIERUNGSLOGIK **
        // ******************************************************

        const applyFormat = (command, value = null) => {
            noteEditor.focus();
            try {
                document.execCommand(command, false, value);
            } catch (e) {
                // Ignoriere Fehler wie 'applyFormat("foreColor", "white")'
            }
            collapseSelection();
            updateToolbarState(); // Aktualisiert den Status nach der Anwendung
        };

        // ... (Der Rest des Codes bleibt unverändert oder wurde bereits durch die neue Logik ersetzt)
        
        // ...
        // ... (Restlicher JavaScript Code) ...
        // ...

        // ******************************************************
        // ** TOOLBAR STATUS AKTUALISIEREN **
        // ******************************************************
        
        const updateToolbarState = () => {
            // ... (unveränderte Logik für Farben/Größen/Bold/Italic/Underline/Link)

            // Aktuellen Listentyp ermitteln
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const currentBlock = getCurrentBlockElement(selection);
                if (currentBlock && currentBlock.tagName === 'LI') {
                    const parentList = currentBlock.parentNode;
                    const listType = parentList.tagName === 'OL' ? 'decimal' : parentList.style.listStyleType || 'disc';
                    
                    // Entferne alle aktiven Listenzustände
                    listDropdownItems.forEach(item => item.classList.remove('active'));
                    
                    // Setze den aktiven Zustand basierend auf dem aktuellen Listentyp/Stil
                    const activeListItem = document.querySelector(`.dropdown-item[data-value="${listType}"]`);
                    if (activeListItem) {
                        activeListItem.classList.add('active');
                    } else if (parentList.tagName === 'UL' && !parentList.style.listStyleType) {
                         // Fallback für ungestylte UL (Standard ist disc)
                        document.querySelector('.dropdown-item[data-value="disc"]').classList.add('active');
                    }
                } else {
                    // Wenn nicht in einer Liste, alle Listenzustände entfernen
                    listDropdownItems.forEach(item => item.classList.remove('active'));
                }
            } else {
                // Wenn keine Auswahl, alle Listenzustände entfernen
                listDropdownItems.forEach(item => item.classList.remove('active'));
            }

            // ... (Rest der updateToolbarState Funktion)
        };
        
        // ******************************************************
        // ** EVENT LISTENER **
        // ******************************************************
        
        // ... (unveränderte Listener für Sortierung, Größe, Farbe)
        
        // Event-Listener für Listen-Items (JETZT MIT NEUER LOGIK)
        listDropdownItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); // Stoppt das Schließen des Dropdowns
                e.currentTarget.blur(); // Blur vor der Ausführung
                
                // RUFE NEUE LIST-LOGIK AUF
                toggleCustomList(item.dataset.value); 

                // Editor Focus im Timeout
                setTimeout(() => {
                    noteEditor.focus();
                    updateToolbarState();
                }, 1);
                listDropdownMenu.classList.remove('active'); // Schließt das Dropdown
            });
        });

        // ... (Restlicher Event-Listener Code) ...
        
        // Initial loading of notes
        window.addEventListener('load', loadNotesFromLocal);
    </script>
</body>
</html>
