<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meine Offline-Notizen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #e2e8f0;
        }
        .note-card {
            background-color: #1a202c;
            border-color: #2d3748;
            cursor: grab;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .note-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        #note-editor {
            min-height: 100px;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #4a5568; 
            background-color: #1a202c;
            color: #ffffff;
            outline: none; 
            transition: all 0.3s;
        }
        
        #note-editor:focus {
            outline: none !important;
        }

        /* *************************************************************** */
        /* ** NEUE BASIS DEFINITION F√úR ALLE BUTTONS (Transition & Flash-Entfernung) ** */
        /* *************************************************************** */
        .toolbar-btn, .dropdown-item, #sort-dropdown-btn, #save-note-btn, #export-btn, 
        label[for="import-file-input"], .edit-btn, .delete-btn, 
        #modal-confirm-btn, #modal-cancel-btn, #link-insert-btn, #link-cancel-btn {
            /* Entfernt den grauen Flash auf mobilen Ger√§ten */
            -webkit-tap-highlight-color: transparent; 
            /* Wichtig: Transition f√ºr Farbe UND Transformation hinzuf√ºgen */
            transition: background-color 0.15s, transform 0.1s, box-shadow 0.1s;
        }
        
        /* Toolbar-Buttons ben√∂tigen einen Standardhintergrund */
        .toolbar-btn, .dropdown-item, #sort-dropdown-btn {
             background-color: #4b5563; /* bg-gray-600 */
        }


        /* *************************************************************** */
        /* ** FIX 1: ENTFERNUNG DES GRAUEN FOKUSRINGS BEIM MAUSKLICK ** */
        /* *************************************************************** */
        .toolbar-btn:focus, 
        .dropdown-item:focus, 
        #sort-dropdown-btn:focus, 
        #save-note-btn:focus,
        #export-btn:focus, 
        label[for="import-file-input"]:focus,
        .edit-btn:focus, .delete-btn:focus, 
        #modal-confirm-btn:focus, #modal-cancel-btn:focus, #link-insert-btn:focus, #link-cancel-btn:focus {
            outline: none !important;
            box-shadow: none !important;
        }
        
        /* *************************************************************** */
        /* ** FIX 2: PRESSEFFEKT (KURZ KLEINER WERDEN) WIE GEW√úNSCHT ** */
        /* *************************************************************** */
        .toolbar-btn:active, .dropdown-item:active, #sort-dropdown-btn:active, 
        #save-note-btn:active, #export-btn:active, label[for="import-file-input"]:active,
        .edit-btn:active, .delete-btn:active, 
        #modal-confirm-btn:active, #modal-cancel-btn:active, #link-insert-btn:active, #link-cancel-btn:active {
            transform: scale(0.95); /* Der Button wird kurz 5% kleiner beim Dr√ºcken */
        }


        /* FIX 3: Definiert den sichtbaren Fokus NUR f√ºr TASTUR-Barrierefreiheit (Tab-Taste) */
        .toolbar-btn:focus-visible, 
        .dropdown-item:focus-visible, 
        #sort-dropdown-btn:focus-visible, 
        #save-note-btn:focus-visible,
        #export-btn:focus-visible, 
        label[for="import-file-input"]:focus-visible {
            outline: 2px solid #3b82f6 !important; /* Blauer Ring f√ºr Tab-Fokus (Tailwind blue-500) */
            outline-offset: 1px;
            box-shadow: none !important; 
        }

        /* Active-Zustand (Blaue Markierung f√ºr Toggle-Buttons) */
        .toolbar-btn.active, .dropdown-item.active {
            background-color: #2563eb !important;
            color: #ffffff !important;
        }

        /* Hover-Zustand */
        .toolbar-btn:hover:not(.active), .dropdown-item:hover:not(.active), #sort-dropdown-btn:hover {
            background-color: #6b7280 !important;
        }

        /* Spezial-Override f√ºr den Save-Button (blau) */
        #save-note-btn { 
             background-color: #2563eb; 
             /* Muss die transform-transition hier behalten */
             transition: all 0.3s, transform 0.1s; 
        }
        
        /* Sicherstellen, dass der blaue Hintergrund auch im Tab-Fokus erhalten bleibt */
        #save-note-btn:focus-visible { 
            background-color: #2563eb !important;
        }
        
        #save-note-btn:hover { background-color: #1d4ed8; }
        
        /* Der :active Hintergrund muss st√§rker sein als :hover */
        #save-note-btn:active { background-color: #1e40af !important; } 
        
        /* *************************************************************** */
        /* ** ENDE FOKUS-FIX UND PRESSEFFEKT ** */
        /* *************************************************************** */


        #note-editor:empty:before {
            content: attr(placeholder);
            color: #718096;
            pointer-events: none;
            display: block;
        }
        
        /* --- STABILISIERTE LISTE-STYLES --- */
        #note-editor li, .note-card li {
            color: #ffffff !important;
        }

        #note-editor li::marker, .note-card li::marker {
            color: #ffffff !important;
        }
        
        #note-editor ul, #note-editor ol, .note-card ul, .note-card ol {
            margin-left: 1.5rem;
        }

        /* Kreise (Hohle Kreise) */
        #note-editor ul[style*="list-style-type: circle"], .note-card ul[style*="list-style-type: circle"] {
            list-style-type: circle !important;
        }
        
        /* Punkte (Gef√ºllte Scheiben/Discs) */
        #note-editor ul[style*="list-style-type: disc"], .note-card ul[style*="list-style-type: disc"] {
            list-style-type: disc !important;
        }
        
        /* Fallback f√ºr ul ohne Stil */
        #note-editor ul:not([style]), .note-card ul:not([style]) {
             list-style-type: disc !important;
        }
        
        #note-editor ol, .note-card ol {
            list-style-type: decimal;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            z-index: 10;
            background-color: #2d3748;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .dropdown-menu.active {
            display: block;
        }
    </style>
</head>
<body class="bg-black min-h-screen p-4 flex items-center justify-center">

    <div class="bg-gray-900 p-6 rounded-3xl shadow-2xl w-full max-w-4xl transition-all duration-300 transform scale-100">
        <header class="mb-6 border-b pb-4 border-gray-700">
            <h1 class="text-4xl font-extrabold text-gray-100 text-center">
                Meine Offline-Notizen
            </h1>
        </header>

        <div class="mb-6 flex flex-col sm:flex-row gap-4">
            <input type="text" id="search-input" placeholder="Notizen durchsuchen..." class="w-full sm:w-1/3 p-3 rounded-xl border border-gray-600 bg-gray-800 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 focus:outline-none">
            
            <div class="flex gap-4 w-full sm:w-2/3">
                <div class="relative w-full sm:w-1/2">
                    <button 
                        id="sort-dropdown-btn" 
                        class="w-full p-3 rounded-xl border border-gray-600 bg-gray-800 text-gray-100 text-left hover:bg-gray-700 transition-colors focus:outline-none">
                        Sortieren nach: Unsortiert
                    </button>
                    <div id="sort-dropdown-menu" class="dropdown-menu mt-2 w-full">
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg active" data-value="unsorted">Unsortiert</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg" data-value="newest">Datum (neueste zuerst)</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg" data-value="oldest">Datum (√§lteste zuerst)</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg" data-value="title-asc">Titel (A-Z)</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg" data-value="title-desc">Titel (Z-A)</button>
                    </div>
                </div>

                <div class="flex gap-2 w-full sm:w-1/2">
                    <button id="export-btn" class="w-1/2 p-3 rounded-xl border border-gray-600 bg-green-600 text-white font-medium hover:bg-green-700 transition-colors focus:outline-none">
                        Export üíæ
                    </button>
                    <label for="import-file-input" 
                        class="w-1/2 p-3 rounded-xl border border-gray-600 bg-yellow-600 text-white font-medium hover:bg-yellow-700 transition-colors cursor-pointer text-center flex items-center justify-center focus:outline-none">
                        Import üì•
                    </label>
                    <input type="file" id="import-file-input" accept="application/json" style="display: none;">
                </div>
            </div>
        </div>

        <div class="mb-6 p-4 bg-gray-800 rounded-2xl shadow-inner">
            <h2 class="text-2xl font-bold text-gray-200 mb-4">Neue Notiz erstellen</h2>
            
            <input type="text" id="note-title-input" placeholder="Titel der Notiz (optional)" class="w-full p-3 mb-4 rounded-xl border border-gray-600 bg-gray-800 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 focus:outline-none">
  
            <div class="flex flex-wrap gap-2 mb-4 p-2 bg-gray-700 rounded-xl">
                <button id="bold-btn" class="toolbar-btn p-2 rounded-lg text-gray-200 hover:bg-gray-500 transition-colors font-bold focus:outline-none">B</button>
                <button id="italic-btn" class="toolbar-btn p-2 rounded-lg text-gray-200 hover:bg-gray-500 transition-colors italic focus:outline-none">I</button>
                <button id="underline-btn" class="toolbar-btn p-2 rounded-lg text-gray-200 hover:bg-gray-500 transition-colors underline focus:outline-none">U</button>
                
                <div class="relative inline-block">
                    <button id="list-dropdown-btn" class="toolbar-btn p-2 rounded-lg text-gray-200 hover:bg-gray-500 transition-colors focus:outline-none">
                        Aufz√§hlung
                    </button>
                    <div id="list-dropdown-menu" class="dropdown-menu">
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg" data-value="decimal">Nummerierung</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg" data-value="disc">Punkte</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg" data-value="circle">Kreise</button>
                    </div>
                </div>

                <div class="relative inline-block">
                    <button id="size-dropdown-btn" class="toolbar-btn p-2 rounded-lg text-gray-200 hover:bg-gray-500 transition-colors focus:outline-none">
                        Schriftgr√∂√üe
                    </button>
                    <div id="size-dropdown-menu" class="dropdown-menu">
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg" data-value="1">Klein</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg" data-value="3">Mittel</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg" data-value="5">Gro√ü</button>
                    </div>
                </div>

                <div class="relative inline-block">
                    <button id="color-dropdown-btn" class="toolbar-btn p-2 rounded-lg text-gray-200 hover:bg-gray-500 transition-colors focus:outline-none">
                        Schriftfarbe
                    </button>
                    <div id="color-dropdown-menu" class="dropdown-menu">
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg text-white" data-value="white">Wei√ü</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg text-red-500" data-value="red">Rot</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg text-green-500" data-value="green">Gr√ºn</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg text-blue-500" data-value="blue">Blau</button>
                        <button class="dropdown-item w-full text-left px-4 py-2 hover:bg-gray-600 rounded-lg text-yellow-500" data-value="yellow">Gelb</button>
                    </div>
                </div>

                <button id="link-btn" class="toolbar-btn p-2 rounded-lg text-gray-200 hover:bg-gray-500 transition-colors focus:outline-none">
                    Link
                </button>

                <button id="indent-btn" class="toolbar-btn p-2 rounded-lg text-gray-200 hover:bg-gray-500 transition-colors focus:outline-none">
                    Einr√ºcken
                </button>
                <button id="outdent-btn" class="toolbar-btn p-2 rounded-lg text-gray-200 hover:bg-gray-500 transition-colors focus:outline-none">
                    Ausr√ºcken
                </button>
            </div>
            
            <div id="note-editor" class="w-full rounded-xl border border-gray-600 bg-gray-800 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none transition-all duration-300" contenteditable="true" placeholder="Schreiben Sie hier Ihre neue Notiz..."></div>
            
            <div class="mt-4 flex justify-end space-x-2">
                <button id="save-note-btn" class="bg-blue-600 text-white font-medium py-2 px-5 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Notiz speichern
                </button>
            </div>
        </div>

        <div id="notes-list" class="space-y-4">
        </div>

        <div id="loading-indicator" class="text-center text-gray-400 mt-8 hidden">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
            <p class="mt-2">Notizen werden geladen...</p>
        </div>

        <div id="no-notes-message" class="text-center text-gray-400 mt-8 hidden">
            <p>Sie haben noch keine Notizen. F√ºgen Sie eine neue hinzu, um zu beginnen!</p>
        </div>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-gray-950 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full">
            <p id="modal-text" class="text-lg font-semibold text-gray-200 text-center mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="modal-confirm-btn" class="bg-blue-600 text-white font-medium py-2 px-5 rounded-full hover:bg-blue-700 transition-colors focus:outline-none">
                    OK
                </button>
                <button id="modal-cancel-btn" class="bg-gray-600 text-gray-200 font-medium py-2 px-5 rounded-full hover:bg-gray-500 transition-colors hidden focus:outline-none">
                    Abbrechen
                </button>
            </div>
        </div>
    </div>

    <div id="link-modal-backdrop" class="fixed inset-0 bg-gray-950 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-lg w-full">
            <h3 class="text-xl font-bold text-gray-200 mb-4 text-center">Link einf√ºgen</h3>
            
            <p class="text-gray-300 mb-4 text-center">Geben Sie die URL f√ºr den Link ein.</p>
            <input type="text" id="link-url-input" placeholder="https://beispiel.de" class="w-full p-3 rounded-xl border border-gray-600 bg-gray-900 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 focus:outline-none">
            <div class="mt-6 flex justify-end space-x-4">
                <button id="link-cancel-btn" class="bg-gray-600 text-gray-200 font-medium py-2 px-5 rounded-full hover:bg-gray-500 transition-colors focus:outline-none">
                    Abbrechen
                </button>
                <button id="link-insert-btn" class="bg-blue-600 text-white font-medium py-2 px-5 rounded-full hover:bg-blue-700 transition-colors focus:outline-none">
                    Einf√ºgen
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM-Elemente
        const notesList = document.getElementById('notes-list');
        const noteTitleInput = document.getElementById('note-title-input');
        const noteEditor = document.getElementById('note-editor');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const searchInput = document.getElementById('search-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noNotesMessage = document.getElementById('no-notes-message');

        const boldBtn = document.getElementById('bold-btn');
        const italicBtn = document.getElementById('italic-btn');
        const underlineBtn = document.getElementById('underline-btn');
        const indentBtn = document.getElementById('indent-btn');
        const outdentBtn = document.getElementById('outdent-btn');
        const linkBtn = document.getElementById('link-btn');
        const listDropdownMenu = document.getElementById('list-dropdown-menu');
        const listDropdownBtn = document.getElementById('list-dropdown-btn');
        const listDropdownItems = listDropdownMenu.querySelectorAll('.dropdown-item');
        const sizeDropdownMenu = document.getElementById('size-dropdown-menu');
        const sizeDropdownBtn = document.getElementById('size-dropdown-btn');
        const sizeDropdownItems = sizeDropdownMenu.querySelectorAll('.dropdown-item');

        const colorDropdownMenu = document.getElementById('color-dropdown-menu');
        const colorDropdownBtn = document.getElementById('color-dropdown-btn');
        const colorDropdownItems = colorDropdownMenu.querySelectorAll('.dropdown-item');

        // Sortier-Elemente
        const sortDropdownBtn = document.getElementById('sort-dropdown-btn');
        const sortDropdownMenu = document.getElementById('sort-dropdown-menu');
        const sortDropdownItems = sortDropdownMenu.querySelectorAll('.dropdown-item');
        
        // KONSTANTEN F√úR IMPORT/EXPORT
        const exportBtn = document.getElementById('export-btn');
        const importFileInput = document.getElementById('import-file-input');
        
        // Modal-Elemente
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalText = document.getElementById('modal-text');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        // Link-Modal-Elemente
        const linkModalBackdrop = document.getElementById('link-modal-backdrop');
        const linkUrlInput = document.getElementById('link-url-input');
        const linkInsertBtn = document.getElementById('link-insert-btn');
        const linkCancelBtn = document.getElementById('link-cancel-btn');

        let notesData = [];
        let editingNoteId = null;
        let savedRange; // Zum Speichern der Auswahl
        let currentSortMethod = 'unsorted';
        
        // Speicherschl√ºssel als Konstante definieren
        const NOTES_STORAGE_KEY = 'notes';
        
        const colorMap = {
            'red': '#ff0000',
            'green': '#008000',
            'blue': '#3b82f6', 
            'yellow': '#ffff00',
            'white': '#ffffff'
        };
        const sizeMap = {
            '1': '12px',
            '3': '16px',
            '5': '24px'
        };
        
        // Drag-and-Drop-Variablen
        let draggedItem = null;
        
        const showModal = (message, showCancelButton = false) => {
            return new Promise(resolve => {
                modalText.textContent = message;
                modalCancelBtn.style.display = showCancelButton ? 'inline-block' : 'none';
                modalBackdrop.classList.remove('hidden');
                
                const confirmHandler = () => {
                    modalBackdrop.classList.add('hidden');
                    resolve(true);
                };
                const cancelHandler = () => {
                    modalBackdrop.classList.add('hidden');
                    resolve(false);
                };
                modalConfirmBtn.onclick = confirmHandler;
                modalCancelBtn.onclick = cancelHandler;
            });
        };
        
        const showLinkModal = () => {
            return new Promise(resolve => {
                linkUrlInput.value = '';
                linkModalBackdrop.classList.remove('hidden');
                const insertHandler = () => {
                    linkModalBackdrop.classList.add('hidden');
                    resolve(linkUrlInput.value);
                };
                const cancelHandler = () => {
                    linkModalBackdrop.classList.add('hidden');
                    resolve(null);
                };
                linkInsertBtn.onclick = insertHandler;
                linkCancelBtn.onclick = cancelHandler;
            });
        };
        
        
        const collapseSelection = () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                // Hebt die aktive Textmarkierung auf und l√§sst nur den Cursor stehen
                selection.collapseToEnd();
            }
        };

        
        const saveNotesToLocal = () => {
            try {
                localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notesData));
            } catch (e) {
                console.error("Fehler beim Speichern der Notizen im lokalen Speicher:", e);
                showModal("Ihre Notizen konnten nicht gespeichert werden. Der lokale Speicher ist m√∂glicherweise voll.");
            }
        };

        
        const loadNotesFromLocal = () => {
            try {
                const storedNotes = localStorage.getItem(NOTES_STORAGE_KEY);
                notesData = storedNotes ? JSON.parse(storedNotes) : [];
                
                // Wende die Standard-Sortierung an, um die UI zu initialisieren und zu rendern
                sortNotes(currentSortMethod);
            } catch (e) {
                console.error("Fehler beim Laden der Notizen aus dem lokalen Speicher:", e);
                notesData = [];
                showModal("Ihre Notizen konnten nicht geladen werden. M√∂glicherweise ist die Datenstruktur besch√§digt.");
                renderNotes();
            }
        };
        
        // --- IMPORT/EXPORT FUNKTIONEN ---
        const exportNotes = async () => { 
            const notesJson = localStorage.getItem(NOTES_STORAGE_KEY);
            if (!notesJson || notesJson === '[]') {
                await showModal('Keine Notizen zum Exportieren vorhanden.', false);
                return;
            }

            const blob = new Blob([notesJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');

            a.href = url;
            a.download = `Meine_Offline_Notizen_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            await showModal('Notizen erfolgreich exportiert!', false);
        };
        const importNotes = (event) => {
             const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    if (Array.isArray(importedNotes)) {
                        
                        // NEUE LOGIK: Kombiniert die bestehenden Notizen mit den importierten Notizen.
                        notesData = notesData.concat(importedNotes);
                        
                        // Speichere die kombinierte Liste in Local Storage
                        saveNotesToLocal();
                        // Lade die Notizen neu und rendere sie (wendet auch die Sortierung an)
                        loadNotesFromLocal();
                        await showModal('Notizen erfolgreich importiert und geladen!', false);
                    } else {
                        await showModal('Fehler: Die importierte Datei hat kein g√ºltiges Notizformat.', false);
                    }
                } catch (error) {
                    await showModal('Fehler beim Lesen oder Parsen der Datei.', false);
                    console.error('Import error:', error);
                }
            };
            reader.onerror = () => {
                showModal('Fehler beim Lesen der Datei.', false);
            };
            reader.readAsText(file);
        };
        // --- ENDE IMPORT/EXPORT FUNKTIONEN ---


        
        const applyFormat = (command, value = null) => {
            document.execCommand(command, false, value);
        };
        
        const toggleList = (command) => {
            applyFormat(command); 
        };
        
        const rgbToHex = (rgb) => {
            if (!rgb || !rgb.startsWith('rgb')) return rgb;
            if(rgb.trim() === '') return '';
            
            const parts = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!parts) return rgb;
            const hex = (x) => {
                const h = parseInt(x).toString(16);
                return h.length === 1 ? '0' + h : h;
            };
            return '#' + hex(parts[1]) + hex(parts[2]) + hex(parts[3]);
        };

        // ******************************************************
        // ** KORRIGIERTE DOM-MANIPULATIONS-LOGIK F√úR LISTEN **
        // ******************************************************
        
        /**
         * Helferfunktion: Findet das n√§chste Block-Level-Element (p, div, li, hx)
         * in Bezug auf den aktuellen Cursor innerhalb des noteEditor.
         */
        const getCurrentBlockElement = (selection) => {
            if (!selection.rangeCount) return null;
            let node = selection.getRangeAt(0).startContainer;
            
            // Wenn es ein Textknoten ist, gehe zum √ºbergeordneten Element
            if (node.nodeType === Node.TEXT_NODE) {
                node = node.parentNode;
            }

            // Finde den n√§chsten Block-Level-Elternteil (P, DIV, LI)
            while (node && node !== noteEditor) {
                const tagName = node.tagName;
                // F√ºge DIV hinzu, falls der Editor ein leeres DIV erstellt (z.B. bei Enter)
                if (['P', 'DIV', 'LI', 'H1', 'H2', 'H3'].includes(tagName)) {
                    return node;
                }
                node = node.parentNode;
            }

            // Fallback
            return noteEditor;
        };

        /**
         * F√ºhrt die unabh√§ngige Listenaktion pro Zeile durch (manuelle DOM-Manipulation).
         * @param {string} targetStyle - 'decimal', 'disc', 'circle'
         */
        const toggleCustomList = (targetStyle) => {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            // Finde das aktuelle Block-Element
            const currentBlock = getCurrentBlockElement(selection);

            if (!currentBlock || currentBlock === noteEditor) {
                // Fallback f√ºr leere Zeile im Root: Erstelle ein P-Tag und rufe Funktion erneut auf
                document.execCommand('insertParagraph', false, null);
                const newP = getCurrentBlockElement(selection);
                if (newP && newP !== noteEditor) {
                    toggleCustomList(targetStyle);
                }
                return;
            }

            const isCurrentlyLi = currentBlock.tagName === 'LI';
            let currentListType = null;
            let currentListStyle = 'none';

            if (isCurrentlyLi) {
                const parentList = currentBlock.parentNode;
                currentListType = parentList.tagName; // 'UL' or 'OL'
                currentListStyle = currentListType === 'OL' ? 
                    'decimal' : (parentList.style.listStyleType || 'disc');
                if (currentListStyle === '') currentListStyle = 'disc';
            }
            
            // ------------------------------------
            // 1. ZIEL: DEAKTIVIERUNG (Toggle OFF)
            // ------------------------------------
            // Pr√ºfe, ob der Zielstil gleich dem aktuellen Stil ist
            if (isCurrentlyLi && (
                (targetStyle === 'decimal' && currentListStyle === 'decimal') ||
                (targetStyle === 'disc' && (currentListStyle === 'disc' || currentListStyle === '')) ||
                (targetStyle === 'circle' && currentListStyle === 'circle')
            )) {
                // Unliste das Element: Content in ein P-Tag zur√ºckf√ºhren
                const content = currentBlock.innerHTML;
                const newBlock = document.createElement('p');
                newBlock.innerHTML = content;
                const parentList = currentBlock.parentNode;
                
                // F√ºge den neuen Block vor der Elternliste ein
                parentList.parentNode.insertBefore(newBlock, parentList);
                currentBlock.remove(); // Entferne das li

                // Aufr√§umen: Wenn die Elternliste jetzt leer ist und nur noch <br> enth√§lt, entferne sie
                if (parentList.children.length === 0 || parentList.innerHTML.trim() === '<br>') {
                    parentList.remove();
                }

                // Setze den Cursor zur√ºck
                selection.removeAllRanges();
                const newRange = document.createRange();
                newRange.selectNodeContents(newBlock);
                newRange.collapse(false);
                selection.addRange(newRange);
                return; // Aktion beendet
            }

            // ------------------------------------
            // 2. ZIEL: STIL-WECHSEL INNERHALB UL (disc <-> circle)
            // ------------------------------------
            if (isCurrentlyLi && currentListType === 'UL' && targetStyle !== 'decimal') {
                const parentList = currentBlock.parentNode;
                // FIX: Explizit 'disc' setzen, nicht leere Zeichenkette
                const targetMarkerStyle = targetStyle === 'disc' ? 'disc' : targetStyle;
                // √Ñndere nur den Stil der Elternliste (der f√ºr diese einzelne LI-Zeile gilt)
                parentList.style.listStyleType = targetMarkerStyle;

                // Cursor wiederherstellen
                selection.removeAllRanges();
                const newRange = document.createRange();
                newRange.selectNodeContents(currentBlock);
                newRange.collapse(false);
                selection.addRange(newRange);
                return; // Aktion beendet
            }

            // ------------------------------------
            // 3. ZIEL: AKTIVIERUNG / TYP-WECHSEL (P/Div -> List, OL -> UL, UL -> OL)
            // ------------------------------------
            let elementToReplace = currentBlock;
            let contentToWrap = currentBlock.innerHTML;

            // 3a. Bei Listen-Wechsel (z.B. OL <-> UL), zuerst das LI aufl√∂sen.
            if (isCurrentlyLi) {
                const parentList = currentBlock.parentNode;
                // Speichere den Inhalt der Zeile
                contentToWrap = currentBlock.innerHTML;
                
                // Erstelle ein P-Tag (dies ist das elementToReplace nach dem Aufr√§umen)
                const tempP = document.createElement('p');
                tempP.innerHTML = contentToWrap;
                
                // F√ºge das P-Tag vor der Elternliste ein
                parentList.parentNode.insertBefore(tempP, parentList);

                // Entferne das LI
                currentBlock.remove();
                
                // Entferne die Elternliste, falls sie jetzt leer ist
                if (parentList.children.length === 0) {
                    parentList.remove();
                }
                
                elementToReplace = tempP;
            }
            
            // 3b. Erstellen der neuen Listenstruktur
            const listTag = targetStyle === 'decimal' ? 'OL' : 'UL';
            const newList = document.createElement(listTag);
            const newLi = document.createElement('li');
            newLi.innerHTML = contentToWrap || '<br>';
            newList.appendChild(newLi);

            // 3c. Style setzen (nur f√ºr UL)
            if (listTag === 'UL') {
                // FIX: Explizit 'disc' setzen, nicht leere Zeichenkette
                const targetMarkerStyle = targetStyle === 'disc' ? 'disc' : targetStyle;
                newList.style.listStyleType = targetMarkerStyle;
            }

            // 3d. Ersetzen im DOM
            if (elementToReplace && elementToReplace.parentNode) {
                elementToReplace.parentNode.replaceChild(newList, elementToReplace);
            } else if (elementToReplace === noteEditor) {
                // Wenn es der Editor selbst ist (z.B. leere Eingabe), f√ºge direkt hinzu
                noteEditor.innerHTML = '';
                noteEditor.appendChild(newList);
            }
            
            // 3e. Cursor setzen
            selection.removeAllRanges();
            const newRange = document.createRange();
            newRange.selectNodeContents(newLi);
            newRange.collapse(false);
            selection.addRange(newRange);
        };
        
        // ******************************************************
        // ** ENDE KORRIGIERTE DOM-MANIPULATIONS-LOGIK **
        // ******************************************************


        // ******************************************************
        // ** TEXTFORMATIERUNG **
        // ******************************************************

        const isFormatActive = (command, value = null) => {
            // Hilfsfunktion zur √úberpr√ºfung des aktiven Zustands von Befehlen.
            if (command === 'bold' || command === 'italic' || command === 'underline' || command === 'outdent' || command === 'indent') {
                return document.queryCommandState(command);
            }
            return false;
        };

        const updateToolbarState = () => {
            // Wenn die Auswahl au√üerhalb des Editors liegt, beenden.
            const selection = window.getSelection();
            if (!selection.rangeCount || !noteEditor.contains(selection.getRangeAt(0).commonAncestorContainer)) {
                return;
            }
            
            // 1. Einfache Befehle (B, I, U)
            boldBtn.classList.toggle('active', isFormatActive('bold'));
            italicBtn.classList.toggle('active', isFormatActive('italic'));
            underlineBtn.classList.toggle('active', isFormatActive('underline'));
        };
        
        const executeDropdownCommand = (btn, menu, command, value) => {
            // Nur Link/Unlink und Listen ben√∂tigen eine benutzerdefinierte Logik
            if (command === 'createLink') {
                // Wird separat √ºber linkBtn-Handler behandelt
                return;
            }
            
            // Listen-Befehle verwenden die erweiterte DOM-Manipulation
            if (command === 'list-style') {
                toggleCustomList(value);
            } else {
                // Standard execCommand f√ºr Font-Gr√∂√üe und Farbe
                applyFormat(command, value);
            }
            
            // Men√º schlie√üen
            menu.classList.remove('active');
            btn.focus(); // Setzt den Fokus zur√ºck auf den Dropdown-Button
            collapseSelection(); // Hebt die Textmarkierung auf, um den Cursor zu belassen
            updateToolbarState();
        };


        // ******************************************************
        // ** EVENT HANDLER **
        // ******************************************************
        
        // --- TOOLBAR EVENTS ---
        boldBtn.addEventListener('click', () => applyFormat('bold'));
        italicBtn.addEventListener('click', () => applyFormat('italic'));
        underlineBtn.addEventListener('click', () => applyFormat('underline'));
        indentBtn.addEventListener('click', () => applyFormat('indent'));
        outdentBtn.addEventListener('click', () => applyFormat('outdent'));

        // Listen-Dropdown-Handler
        listDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            // Schlie√üt alle anderen Dropdowns
            sizeDropdownMenu.classList.remove('active');
            colorDropdownMenu.classList.remove('active');
            listDropdownMenu.classList.toggle('active');
        });
        listDropdownItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const value = e.target.getAttribute('data-value');
                executeDropdownCommand(listDropdownBtn, listDropdownMenu, 'list-style', value);
            });
        });

        // Schriftgr√∂√üe-Dropdown-Handler
        sizeDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            colorDropdownMenu.classList.remove('active');
            listDropdownMenu.classList.remove('active');
            sizeDropdownMenu.classList.toggle('active');
        });
        sizeDropdownItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const value = e.target.getAttribute('data-value');
                executeDropdownCommand(sizeDropdownBtn, sizeDropdownMenu, 'fontSize', value);
            });
        });

        // Farbe-Dropdown-Handler
        colorDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            sizeDropdownMenu.classList.remove('active');
            listDropdownMenu.classList.remove('active');
            colorDropdownMenu.classList.toggle('active');
        });
        colorDropdownItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const value = colorMap[e.target.getAttribute('data-value')];
                executeDropdownCommand(colorDropdownBtn, colorDropdownMenu, 'foreColor', value);
            });
        });
        
        // Link-Button Handler (Komplexe Logik)
        linkBtn.addEventListener('click', async () => {
            // 1. Speichere die aktuelle Auswahl VOR dem √ñffnen des Modals
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                savedRange = selection.getRangeAt(0);
            } else {
                await showModal("Bitte w√§hlen Sie zuerst einen Text aus, den Sie verlinken m√∂chten.", false);
                return;
            }
            
            // 2. √ñffne das Modal und warte auf Eingabe
            const url = await showLinkModal();
            
            // 3. F√ºhre den Befehl aus, wenn eine URL zur√ºckgegeben wurde
            if (url) {
                // Stelle die Auswahl wieder her
                selection.removeAllRanges();
                selection.addRange(savedRange);
                
                // F√ºge den Link ein
                document.execCommand('createLink', false, url);
                
                // Aufr√§umen
                savedRange = null;
                collapseSelection();
            }
        });
        
        // Globale Klick-Handler zum Schlie√üen von Dropdowns
        document.addEventListener('click', (e) => {
            // Pr√ºfen, ob der Klick au√üerhalb eines Dropdowns stattfand
            const isDropdownClick = e.target.closest('.relative.inline-block') || e.target.closest('#sort-dropdown-btn');
            const isSortDropdownClick = e.target.closest('#sort-dropdown-btn');

            if (!isDropdownClick) {
                listDropdownMenu.classList.remove('active');
                sizeDropdownMenu.classList.remove('active');
                colorDropdownMenu.classList.remove('active');
            }

            // Nur Sortier-Dropdown schlie√üen, wenn nicht der Sortier-Button selbst geklickt wurde
            if (!isSortDropdownClick) {
                 sortDropdownMenu.classList.remove('active');
            }
        });
        
        // --- SORTIER-FUNKTIONEN ---
        const sortNotes = (method) => {
            // Sortiert die notesData In-Place
            switch (method) {
                case 'newest':
                    notesData.sort((a, b) => b.timestamp - a.timestamp);
                    break;
                case 'oldest':
                    notesData.sort((a, b) => a.timestamp - b.timestamp);
                    break;
                case 'title-asc':
                    notesData.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'title-desc':
                    notesData.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case 'unsorted':
                default:
                    // F√ºr 'unsorted' wird die Reihenfolge in notesData beibehalten,
                    // die der Benutzer manuell per Drag & Drop gesetzt hat.
                    // Beim Laden wird notesData bereits in der gespeicherten Reihenfolge geladen.
                    break;
            }
            currentSortMethod = method;
            renderNotes(searchInput.value);
            // Speichere die neue Sortierreihenfolge, falls sie dauerhaft sein soll (nur relevant f√ºr Drag/Drop)
            if (method !== 'unsorted') {
                saveNotesToLocal();
            }
        };

        const updateSortDropdownText = (method) => {
            let text = 'Sortieren nach: ';
            const item = Array.from(sortDropdownItems).find(i => i.getAttribute('data-value') === method);
            if (item) {
                text += item.textContent.trim();
                // Active-Klasse im Men√º aktualisieren
                sortDropdownItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            } else {
                text += 'Unsortiert';
            }
            sortDropdownBtn.textContent = text;
        };
        
        // Sortier-Dropdown-Handler
        sortDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            sortDropdownMenu.classList.toggle('active');
            // Stelle sicher, dass andere Dropdowns geschlossen sind (gilt nur f√ºr die Haupt-Toolbar)
        });
        sortDropdownItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const method = e.target.getAttribute('data-value');
                sortNotes(method);
                updateSortDropdownText(method);
                sortDropdownMenu.classList.remove('active');
            });
        });
        
        // --- DRAG-AND-DROP FUNKTIONEN ---
        const handleDragStart = (e) => {
            if (currentSortMethod !== 'unsorted') {
                e.preventDefault();
                return;
            }
            draggedItem = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedItem.innerHTML); // Ben√∂tigt, aber Inhalt irrelevant
            setTimeout(() => {
                draggedItem.classList.add('dragging');
            }, 0);
        };

        const handleDragOver = (e) => {
            if (e.preventDefault) e.preventDefault(); // Erm√∂glicht das Ablegen
            e.dataTransfer.dropEffect = 'move';
            
            // Visuelle Hilfe: Finde das Element, √ºber dem gedroppt wird, und zeige Platzhalter-Stil.
            const target = e.target.closest('.note-card');
            if (target && target !== draggedItem) {
                const rect = target.getBoundingClientRect();
                const next = (e.clientY - rect.top) / rect.height > 0.5; // Pr√ºft, ob √ºber oder unter der Mitte
                
                // Entferne alle Platzhalter-Klassen
                notesList.querySelectorAll('.note-card').forEach(n => {
                    n.classList.remove('drag-over-top', 'drag-over-bottom');
                });
                
                // Setze die entsprechende Platzhalter-Klasse
                if (next) {
                    target.classList.add('drag-over-bottom');
                } else {
                    target.classList.add('drag-over-top');
                }
            }
            
            return false;
        };

        const handleDrop = (e) => {
            e.stopPropagation(); 
            
            // Entferne alle Platzhalter-Klassen
            notesList.querySelectorAll('.note-card').forEach(n => {
                n.classList.remove('drag-over-top', 'drag-over-bottom');
            });
            
            if (draggedItem !== e.target.closest('.note-card') && currentSortMethod === 'unsorted') {
                const dropTarget = e.target.closest('.note-card');
                if (!dropTarget) return;

                const dropIndex = notesData.findIndex(n => n.id === dropTarget.getAttribute('data-id'));
                const dragIndex = notesData.findIndex(n => n.id === draggedItem.getAttribute('data-id'));
                
                if (dropIndex === -1 || dragIndex === -1) return;

                // Verschieben des Elements in notesData
                const [itemToMove] = notesData.splice(dragIndex, 1);

                // Ermitteln der Drop-Position basierend auf dem visuellen Platzhalter
                const rect = dropTarget.getBoundingClientRect();
                const insertAfter = (e.clientY - rect.top) / rect.height > 0.5;
                
                let newIndex = dropIndex;
                if (insertAfter) {
                    newIndex += 1; // Nach dem Drop-Target einf√ºgen
                }
                
                // F√ºge das Element an der neuen Position ein
                notesData.splice(newIndex, 0, itemToMove);
                
                saveNotesToLocal();
                renderNotes();
            }
            return false;
        };

        const handleDragEnd = (e) => {
            draggedItem.classList.remove('dragging');
            // Entferne alle Platzhalter-Klassen
            notesList.querySelectorAll('.note-card').forEach(n => {
                n.classList.remove('drag-over-top', 'drag-over-bottom');
            });
            draggedItem = null;
        };
        
        // --- ENDE DRAG-AND-DROP FUNKTIONEN ---


        // ******************************************************
        // ** CRUD-LOGIK **
        // ******************************************************

        const sanitizeHTML = (html) => {
            // Erlaubt nur P, DIV, UL, OL, LI, SPAN, FONT (f√ºr execCommand) und g√§ngige Formatierungen
            // Achtung: Ein vollwertiger Sanitizer ist komplex. Dies ist eine rudiment√§re Bereinigung
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Entferne Skripte und andere gef√§hrliche Elemente
            tempDiv.querySelectorAll('script, style, iframe, object, embed').forEach(el => el.remove());
            
            // Entferne unerw√ºnschte Attribute (wie onclick)
            tempDiv.querySelectorAll('*').forEach(el => {
                Array.from(el.attributes).forEach(attr => {
                    if (attr.name.startsWith('on') || attr.name === 'id' || attr.name === 'class') {
                        el.removeAttribute(attr.name);
                    }
                });
            });
            
            return tempDiv.innerHTML;
        };


        const saveNote = () => {
            const title = noteTitleInput.value.trim();
            const content = noteEditor.innerHTML.trim();
            const sanitizedContent = sanitizeHTML(content);

            if (!title && !sanitizedContent) {
                showModal('Die Notiz ist leer. Bitte geben Sie einen Titel oder Inhalt ein.', false);
                return;
            }

            if (editingNoteId) {
                // Notiz bearbeiten
                const noteIndex = notesData.findIndex(n => n.id === editingNoteId);
                if (noteIndex !== -1) {
                    notesData[noteIndex].title = title;
                    notesData[noteIndex].content = sanitizedContent;
                    // Der Timestamp wird NICHT aktualisiert, um die urspr√ºngliche Sortierung beizubehalten
                }
                editingNoteId = null;
                saveNoteBtn.textContent = 'Notiz speichern';
            } else {
                // Neue Notiz erstellen
                const newNote = {
                    id: Date.now().toString(), // Ein einfacher, eindeutiger ID-Generator
                    title: title,
                    content: sanitizedContent,
                    timestamp: Date.now()
                };
                
                // F√ºgt neue Notiz immer am Anfang der Liste hinzu, wenn unsortiert
                if (currentSortMethod === 'unsorted' || currentSortMethod === 'newest') {
                    notesData.unshift(newNote);
                } else if (currentSortMethod === 'oldest') {
                    notesData.push(newNote);
                } else {
                    // Bei Titelsortierung die neue Notiz einf√ºgen und neu sortieren
                    notesData.unshift(newNote);
                    sortNotes(currentSortMethod);
                }
            }

            // Felder leeren und Notizen speichern/rendern
            noteTitleInput.value = '';
            noteEditor.innerHTML = '';
            saveNotesToLocal();
            renderNotes(searchInput.value);
            collapseSelection();
        };

        const editNote = (id, title, content) => {
            // Setzt den Editor in den Bearbeitungsmodus
            editingNoteId = id;
            noteTitleInput.value = title;
            noteEditor.innerHTML = content;
            saveNoteBtn.textContent = '√Ñnderungen speichern';
            noteEditor.focus();
            
            // Scroll zum Editor
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        };

        const deleteNote = async (id) => {
            const confirmed = await showModal('Sind Sie sicher, dass Sie diese Notiz l√∂schen m√∂chten?', true);
            if (confirmed) {
                notesData = notesData.filter(n => n.id !== id);
                
                // Wenn die gerade bearbeitete Notiz gel√∂scht wird, Editor zur√ºcksetzen
                if (editingNoteId === id) {
                    editingNoteId = null;
                    noteTitleInput.value = '';
                    noteEditor.innerHTML = '';
                    saveNoteBtn.textContent = 'Notiz speichern';
                }
                
                saveNotesToLocal();
                renderNotes(searchInput.value);
            }
        };


        const renderNotes = (searchTerm = '') => {
            notesList.innerHTML = '';
            const normalizedSearchTerm = searchTerm.toLowerCase();
            let notesFound = 0;

            const filteredNotes = notesData.filter(note => {
                const contentText = noteEditor.textContent.toLowerCase();
                const contentHtml = note.content.toLowerCase();
                return note.title.toLowerCase().includes(normalizedSearchTerm) ||
                       contentHtml.includes(normalizedSearchTerm);
            });

            if (filteredNotes.length === 0) {
                if (notesData.length > 0) {
                    // Nur anzeigen, wenn Notizen existieren, aber der Suchbegriff nichts findet
                    noNotesMessage.classList.remove('hidden');
                    noNotesMessage.querySelector('p').textContent = 'Keine Notizen gefunden, die dem Suchbegriff entsprechen.';
                } else {
                    noNotesMessage.classList.remove('hidden');
                    noNotesMessage.querySelector('p').textContent = 'Sie haben noch keine Notizen. F√ºgen Sie eine neue hinzu, um zu beginnen!';
                }
            } else {
                 noNotesMessage.classList.add('hidden');
            }


            filteredNotes.forEach(note => {
                const noteCard = createNoteCard(note);
                notesList.appendChild(noteCard);
                notesFound++;
            });
            
            // Anzeigen des Ladezustands und Nachrichten aktualisieren
            loadingIndicator.classList.add('hidden');
        };

        const createNoteCard = (note) => {
             const div = document.createElement('div');
             div.className = 'note-card p-4 rounded-xl shadow-lg border-l-4 border-gray-600 transition-all duration-300 hover:shadow-xl hover:border-gray-500';
             div.setAttribute('data-id', note.id);
             
             // Nur Drag-Eigenschaften setzen, wenn nach 'unsorted' sortiert wird
             if (currentSortMethod === 'unsorted') {
                 div.setAttribute('draggable', 'true');
             }

             // Der Hauptinhalt der Notizkarte
             const contentHtml = `
                 <h3 class="text-xl font-semibold text-gray-100 mb-2 whitespace-pre-wrap">${note.title || 'Ohne Titel'}</h3>
                 <div class="text-gray-300 mb-3 overflow-hidden max-h-40 note-content whitespace-pre-wrap">${note.content}</div>
                 <div class="flex justify-end space-x-2">
                     <button class="edit-btn text-blue-400 hover:text-blue-300 font-medium transition-colors">Bearbeiten</button>
                     <button class="delete-btn text-red-400 hover:text-red-300 font-medium transition-colors">L√∂schen</button>
                 </div>
             `;
             div.innerHTML = contentHtml;
             
             // Event-Listener hinzuf√ºgen
             div.querySelector('.edit-btn').addEventListener('click', () => editNote(note.id, note.title, note.content));
             div.querySelector('.delete-btn').addEventListener('click', () => deleteNote(note.id));
             
             // Nur Drag-Listener hinzuf√ºgen, wenn Drag erlaubt ist
             if (currentSortMethod === 'unsorted') {
                 div.addEventListener('dragstart', handleDragStart);
                 div.addEventListener('dragover', handleDragOver);
                 div.addEventListener('drop', handleDrop);
                 div.addEventListener('dragend', handleDragEnd);
             }
             return div;
         };


        saveNoteBtn.addEventListener('click', saveNote);
        searchInput.addEventListener('input', (e) => renderNotes(e.target.value));
        
        exportBtn.addEventListener('click', exportNotes);
        importFileInput.addEventListener('change', importNotes);
        
        // Event listener zur Aktualisierung des Toolbar-Zustands
        noteEditor.addEventListener('mouseup', updateToolbarState); 
        
        // ** GE√ÑNDERT: Implementiert Touch-Click-Verhalten **
        noteEditor.addEventListener('keyup', () => {
            collapseSelection();
            updateToolbarState();
        }); 
        
        noteEditor.addEventListener('focus', updateToolbarState);
        noteEditor.addEventListener('blur', updateToolbarState);

        // Initial loading of notes
        window.addEventListener('load', loadNotesFromLocal);
    </script>
</body>
</html>
